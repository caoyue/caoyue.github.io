<html lang="zh"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="default"/><meta name="format-detection" content="telephone=no"/><meta name="theme-color" content="#a6d6d6"/><meta name="msapplication-TileColor" content="#a6d6d6"/><meta name="msapplication-TileImage" content="/icon/favicon.ico"/><meta name="referrer" content="no-referrer"/><title>且听疯吟 / 在 Windows 8 Desktop App 中使用 Toast Notification</title><link rel="alternate" type="application/rss+xml" title="atom 1.0" href="/atom.xml"/><link rel="apple-touch-icon" sizes="192x192" href="/icon/favicon.ico"/><link rel="icon" type="image/png" sizes="48x48" href="/icon/favicon.ico"/><link rel="icon" type="image/png" sizes="192x192" href="/icon/favicon.ico"/><link rel="stylesheet" href="/css/normalize.css"/><link rel="stylesheet" href="/css/style.css"/><meta name="generator" content="Hexo 6.0.0"></head><body><div class="wrap"><div class="header"><a href="/" title="this is a link">且听疯吟</a><span>如此生活三十年</span></div><div class="left"><ul class="list"><li><a href="/" title="Home">Home</a></li><li><a href="/archives" title="archive">Archive</a></li><li><a href="/tags" title="Tags">Tags</a></li></ul></div><div class="right"><div class="entry" id="content"><div class="title">在 Windows 8 Desktop App 中使用 Toast Notification</div><div class="content"><p>最近坐久了就感觉腰酸背痛，想要做个定时提醒，提醒自己定时休息走动一下。<br>现在的定时提醒软件要么太复杂要么太难看，本来想要使用系统自带的定时任务，但是 Windows 8 中废弃了计划任务中的弹出消息功能。</p>
<p>想到 Windows 8 中新增了 Toast Notification，能不能利用这个方式来提醒？但是没见过 Desktop app 使用这个功能，一直以为是 Windows Store App 专用的 API。<br>在翻 MSDN 的时候发现原来 Metro Toast Notification 适用范围也包括 Desktop app。然后折腾了一下，居然成功了:)</p>
<p><img src="http://ww4.sinaimg.cn/large/3e69b0ccgw1ehmsd3xs5xj20eu06sjs0.jpg" alt="demo"></p>
<h3 id="在-Desktop-app-中使用-Windows-8-x2F-Windows-RT-API"><a href="#在-Desktop-app-中使用-Windows-8-x2F-Windows-RT-API" class="headerlink" title="在 Desktop app 中使用 Windows 8&#x2F;Windows RT API"></a>在 Desktop app 中使用 Windows 8&#x2F;Windows RT API</h3><p>Toast 位于 <code>Windows.UI.Notifications</code> 命名空间中，但是默认情况下没法引用该命名空间，因为其中一些 API 在 Desktop 环境下是有限制的。幸运的是 Toast Notification 不属于其中。可以从 MSDN 上找到这些 API 的详细信息，其中就包括了适用范围 。</p>
<ul>
<li>建立一个 Console Application，为了引用 <code>Windows.UI.Notifications</code>，需要编辑项目文件 <code> .csproj</code>。在第一个 <code>PropertyGroup</code> 节点中添加</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TargetPlatformVersion</span>&gt;</span>8.0<span class="tag">&lt;/<span class="name">TargetPlatformVersion</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>重新 Load 项目，添加引用。可以看到引用管理器左边添加了新的一列 <code>Windows</code>，添加 <code>Windows.Data.Xml.Dom</code> <code>Windows.UI.Notifications</code><br><code> Windows.Foundation</code> 的引用。</li>
<li>添加对 <code>System.Runtime</code> 和 <code>System.Runtime.InteropService.WindowsRuntime</code> 的引用。</li>
</ul>
<h3 id="使用-Console-app-创建-Toast-Notification"><a href="#使用-Console-app-创建-Toast-Notification" class="headerlink" title="使用 Console app 创建 Toast Notification"></a>使用 Console app 创建 Toast Notification</h3><p>接下来需要创建一个 <code>ToastTemplateType</code> 对应的 <code>XmlDocument</code> 对象。<br>关于不同的 <code>ToastTemplateType</code> ，可以在 <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.notifications.toasttemplatetype">MSDN</a> 找到详细的信息。<br>以 <code>ToastTemplateType.ToastImageAndText04</code> 为例，这是一个带有 Image 和三行文字的 Toast Template</p>
<ul>
<li>创建 Template 如下：</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">XmlDocument toastXml = ToastNotificationManager.GetTemplateContent(ToastTemplateType.ToastImageAndText04);</span><br><span class="line"></span><br><span class="line">Windows.Data.Xml.Dom.XmlNodeList stringElements = toastXml.GetElementsByTagName(<span class="string">&quot;text&quot;</span>);</span><br><span class="line">stringElements[<span class="number">0</span>].AppendChild(toastXml.CreateTextNode(<span class="string">&quot;Head&quot;</span>));</span><br><span class="line">stringElements[<span class="number">1</span>].AppendChild(toastXml.CreateTextNode(<span class="string">&quot;Content1&quot;</span>));</span><br><span class="line">stringElements[<span class="number">2</span>].AppendChild(toastXml.CreateTextNode(<span class="string">&quot;Content2&quot;</span>));</span><br><span class="line"></span><br><span class="line">String imagePath = <span class="string">&quot;file:///&quot;</span> + Path.GetFullPath(<span class="string">&quot;toastImageAndText.png&quot;</span>);</span><br><span class="line">Windows.Data.Xml.Dom.XmlNodeList imageElements = toastXml.GetElementsByTagName(<span class="string">&quot;image&quot;</span>);</span><br><span class="line">imageElements[<span class="number">0</span>].Attributes.GetNamedItem(<span class="string">&quot;src&quot;</span>).NodeValue = imagePath;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 Toast 并添加事件：</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ToastNotification toast = <span class="keyword">new</span> ToastNotification(toastXml);</span><br><span class="line">toast.Activated += ToastActivated;</span><br><span class="line">toast.Dismissed += ToastDismissed;</span><br><span class="line">toast.Failed += ToastFailed;</span><br></pre></td></tr></table></figure>

<ul>
<li>弹出 Toast:<br/><br>在 Desktop app 中使用 Toast 时需要一个 App id，否则会出现 <code>找不到元素</code> 的异常。</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> appId = <span class="string">&quot;Microsoft.Samples.DesktopToastsSample&quot;</span>;</span><br><span class="line">ToastNotificationManager.CreateToastNotifier(appId).Show(toast);</span><br></pre></td></tr></table></figure>

<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>这里是个简单的示例项目源码 <a target="_blank" rel="noopener" href="https://github.com/caoyue/Windows8ToastNotification">Windows8ToastNotification</a><br>考虑用这个写个小玩具，可以获取关注的 Twitter、世界杯比分、天气预报之类的通知，支持 API 自定义，想想还挺好玩的，完成后会更新到 Github。</p>
</div><div><ul class="info"><li>posted on 2014-06-22<li><a href="/tags/csharp/">#csharp</a></li><li><a href="/tags/windows/">#windows</a></li></li></ul></div></div><div id="disqus_thread"></div><script>var disqus_config = function () {
    this.page.url = "https://blog.caoyue.me/post/use-toast-in-windows-desktop-app/";
    this.page.identifier = "post/use-toast-in-windows-desktop-app/";
};

(function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://caoyue.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script></div><div class="footer"><div></div>©2021<a href="https://blog.caoyue.me"> 且听疯吟</a>. designed by<a href="https://caoyue.me" target="_blank"> caoyue</a>. powered by<a href="https://hexo.io/" target="_blank"> hexo</a></div><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
</div></body></html>