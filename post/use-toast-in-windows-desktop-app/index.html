<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="最近坐久了就感觉腰酸背痛，想要做个定时提醒，提醒自己定时休息走动一下。
现在的定时提醒软件要么太复杂要么太难看，本来想要使用系统自带的定时任务，但是 Windows 8 中废弃了计划任务中的弹出消息功能。
想到 Windows 8 中新增了 Toast Notification，能不能利用这个方式来提醒？但是没见过 Desktop app 使用这个功能，一直以为是 Windows Store App 专用的 API。
在翻 MSDN 的时候发现原来 Metro Toast Notification 适用范围也包括 Desktop app。然后折腾了一下，居然成功了:)
在 Desktop app 中使用 Windows 8/Windows RT API Toast 位于 Windows.UI.Notifications 命名空间中，但是默认情况下没法引用该命名空间，因为其中一些 API 在 Desktop 环境下是有限制的。幸运的是 Toast Notification 不属于其中。可以从 MSDN 上找到这些 API 的详细信息，其中就包括了适用范围 。
 建立一个 Console Application，为了引用 Windows.UI.Notifications，需要编辑项目文件  .csproj。在第一个 PropertyGroup 节点中添加  <TargetPlatformVersion>8.0</TargetPlatformVersion>  重新 Load 项目，添加引用。可以看到引用管理器左边添加了新的一列 Windows，添加 Windows.Data.Xml.Dom Windows.UI.Notifications"><meta name=author content="caoyue"><title>且听疯吟 / 在 Windows 8 Desktop App 中使用 Toast Notification</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>在 Windows 8 Desktop App 中使用 Toast Notification</div><div class=content><p>最近坐久了就感觉腰酸背痛，想要做个定时提醒，提醒自己定时休息走动一下。<br>现在的定时提醒软件要么太复杂要么太难看，本来想要使用系统自带的定时任务，但是 Windows 8 中废弃了计划任务中的弹出消息功能。</p><p>想到 Windows 8 中新增了 Toast Notification，能不能利用这个方式来提醒？但是没见过 Desktop app 使用这个功能，一直以为是 Windows Store App 专用的 API。<br>在翻 MSDN 的时候发现原来 Metro Toast Notification 适用范围也包括 Desktop app。然后折腾了一下，居然成功了:)</p><p><img src=http://ww4.sinaimg.cn/large/3e69b0ccgw1ehmsd3xs5xj20eu06sjs0.jpg alt=demo></p><h3 id=在-desktop-app-中使用-windows-8windows-rt-api>在 Desktop app 中使用 Windows 8/Windows RT API</h3><p>Toast 位于 <code>Windows.UI.Notifications</code> 命名空间中，但是默认情况下没法引用该命名空间，因为其中一些 API 在 Desktop 环境下是有限制的。幸运的是 Toast Notification 不属于其中。可以从 MSDN 上找到这些 API 的详细信息，其中就包括了适用范围 。</p><ul><li>建立一个 Console Application，为了引用 <code>Windows.UI.Notifications</code>，需要编辑项目文件 <code>.csproj</code>。在第一个 <code>PropertyGroup</code> 节点中添加</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Xml data-lang=Xml><span class=line><span class=cl><span class=nt>&lt;TargetPlatformVersion&gt;</span>8.0<span class=nt>&lt;/TargetPlatformVersion&gt;</span>
</span></span></code></pre></div><ul><li>重新 Load 项目，添加引用。可以看到引用管理器左边添加了新的一列 <code>Windows</code>，添加 <code>Windows.Data.Xml.Dom</code> <code>Windows.UI.Notifications</code><br><code>Windows.Foundation</code> 的引用。</li><li>添加对 <code>System.Runtime</code> 和 <code>System.Runtime.InteropService.WindowsRuntime</code> 的引用。</li></ul><h3 id=使用-console-app-创建-toast-notification>使用 Console app 创建 Toast Notification</h3><p>接下来需要创建一个 <code>ToastTemplateType</code> 对应的 <code>XmlDocument</code> 对象。<br>关于不同的 <code>ToastTemplateType</code> ，可以在 <a href=http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.notifications.toasttemplatetype>MSDN</a> 找到详细的信息。<br>以 <code>ToastTemplateType.ToastImageAndText04</code> 为例，这是一个带有 Image 和三行文字的 Toast Template</p><ul><li>创建 Template 如下：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-CSharp data-lang=CSharp><span class=line><span class=cl><span class=n>XmlDocument</span> <span class=n>toastXml</span> <span class=p>=</span> <span class=n>ToastNotificationManager</span><span class=p>.</span><span class=n>GetTemplateContent</span><span class=p>(</span><span class=n>ToastTemplateType</span><span class=p>.</span><span class=n>ToastImageAndText04</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Windows</span><span class=p>.</span><span class=n>Data</span><span class=p>.</span><span class=n>Xml</span><span class=p>.</span><span class=n>Dom</span><span class=p>.</span><span class=n>XmlNodeList</span> <span class=n>stringElements</span> <span class=p>=</span> <span class=n>toastXml</span><span class=p>.</span><span class=n>GetElementsByTagName</span><span class=p>(</span><span class=s>&#34;text&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>stringElements</span><span class=p>[</span><span class=m>0</span><span class=p>].</span><span class=n>AppendChild</span><span class=p>(</span><span class=n>toastXml</span><span class=p>.</span><span class=n>CreateTextNode</span><span class=p>(</span><span class=s>&#34;Head&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=n>stringElements</span><span class=p>[</span><span class=m>1</span><span class=p>].</span><span class=n>AppendChild</span><span class=p>(</span><span class=n>toastXml</span><span class=p>.</span><span class=n>CreateTextNode</span><span class=p>(</span><span class=s>&#34;Content1&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=n>stringElements</span><span class=p>[</span><span class=m>2</span><span class=p>].</span><span class=n>AppendChild</span><span class=p>(</span><span class=n>toastXml</span><span class=p>.</span><span class=n>CreateTextNode</span><span class=p>(</span><span class=s>&#34;Content2&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>imagePath</span> <span class=p>=</span> <span class=s>&#34;file:///&#34;</span> <span class=p>+</span> <span class=n>Path</span><span class=p>.</span><span class=n>GetFullPath</span><span class=p>(</span><span class=s>&#34;toastImageAndText.png&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Windows</span><span class=p>.</span><span class=n>Data</span><span class=p>.</span><span class=n>Xml</span><span class=p>.</span><span class=n>Dom</span><span class=p>.</span><span class=n>XmlNodeList</span> <span class=n>imageElements</span> <span class=p>=</span> <span class=n>toastXml</span><span class=p>.</span><span class=n>GetElementsByTagName</span><span class=p>(</span><span class=s>&#34;image&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>imageElements</span><span class=p>[</span><span class=m>0</span><span class=p>].</span><span class=n>Attributes</span><span class=p>.</span><span class=n>GetNamedItem</span><span class=p>(</span><span class=s>&#34;src&#34;</span><span class=p>).</span><span class=n>NodeValue</span> <span class=p>=</span> <span class=n>imagePath</span><span class=p>;</span>
</span></span></code></pre></div><ul><li>创建 Toast 并添加事件：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-CSharp data-lang=CSharp><span class=line><span class=cl><span class=n>ToastNotification</span> <span class=n>toast</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ToastNotification</span><span class=p>(</span><span class=n>toastXml</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>toast</span><span class=p>.</span><span class=n>Activated</span> <span class=p>+=</span> <span class=n>ToastActivated</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>toast</span><span class=p>.</span><span class=n>Dismissed</span> <span class=p>+=</span> <span class=n>ToastDismissed</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>toast</span><span class=p>.</span><span class=n>Failed</span> <span class=p>+=</span> <span class=n>ToastFailed</span><span class=p>;</span>
</span></span></code></pre></div><ul><li>弹出 Toast:<br><br>在 Desktop app 中使用 Toast 时需要一个 App id，否则会出现 <code>找不到元素</code> 的异常。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-CSharp data-lang=CSharp><span class=line><span class=cl><span class=kt>string</span> <span class=n>appId</span> <span class=p>=</span> <span class=s>&#34;Microsoft.Samples.DesktopToastsSample&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>ToastNotificationManager</span><span class=p>.</span><span class=n>CreateToastNotifier</span><span class=p>(</span><span class=n>appId</span><span class=p>).</span><span class=n>Show</span><span class=p>(</span><span class=n>toast</span><span class=p>);</span>
</span></span></code></pre></div><h3 id=其他>其他</h3><p>这里是个简单的示例项目源码 <a href=https://github.com/caoyue/Windows8ToastNotification>Windows8ToastNotification</a><br>考虑用这个写个小玩具，可以获取关注的 Twitter、世界杯比分、天气预报之类的通知，支持 API 自定义，想想还挺好玩的，完成后会更新到 Github。</p></div><div class=tags><ul class=info><li>2014-06-22</li><li><a href=https://blog.caoyue.me/tags/windows>#windows</a></li><li><a href=https://blog.caoyue.me/tags/csharp>#csharp</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",''),document.querySelector("section.article.discussion").innerHTML='',document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2022 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch(e){}</script></div></footer></div></body></html>