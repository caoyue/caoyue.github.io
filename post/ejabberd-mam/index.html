<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="MAM - Message Archive Management 1. Message Archive Archiving archived tag <message to='juliet@capulet.lit/balcony' from='romeo@montague.lit/orchard' type='chat'> <body>Call me but love, and I'll be new baptized; Henceforth I never will be Romeo.</body> <archived by='juliet@capulet.lit' id='28482-98726-73623' /> </message> 2. Querying Filtering
by jid <iq type='get' id='juliet1'> <query xmlns='urn:xmpp:mam:tmp'> <with>juliet@capulet.lit</with> </query> </iq> by time <iq type='get' id='juliet1'> <query xmlns='urn:xmpp:mam:tmp'> <start>2010-06-07T00:00:00Z</start> <end>2010-07-07T13:23:54Z</end> </query> </iq> by max number by uid of message <iq type='get' id='q29303'> <query xmlns='urn:xmpp:mam:tmp'> <start>2010-08-07T00:00:00Z</start> <set xmlns='http://jabber."><meta name=author content="caoyue"><title>且听疯吟 / ejabberd-MAM</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>ejabberd-MAM</div><div class=content><h3 id=mam---message-archive-management>MAM - Message Archive Management</h3><h4 id=1-message-archive>1. Message Archive</h4><ul><li>Archiving<br><br>archived tag<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;message</span> <span class=na>to=</span><span class=s>&#39;juliet@capulet.lit/balcony&#39;</span>
</span></span><span class=line><span class=cl>  <span class=na>from=</span><span class=s>&#39;romeo@montague.lit/orchard&#39;</span>
</span></span><span class=line><span class=cl>  <span class=na>type=</span><span class=s>&#39;chat&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;body&gt;</span>Call me but love, and I&#39;ll be new baptized; Henceforth I never will be Romeo.<span class=nt>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;archived</span> <span class=na>by=</span><span class=s>&#39;juliet@capulet.lit&#39;</span> <span class=na>id=</span><span class=s>&#39;28482-98726-73623&#39;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/message&gt;</span>
</span></span></code></pre></div></li></ul><h4 id=2-querying>2. Querying</h4><ul><li><p>Filtering</p><ul><li>by jid<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>type=</span><span class=s>&#39;get&#39;</span> <span class=na>id=</span><span class=s>&#39;juliet1&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;query</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;with&gt;</span>juliet@capulet.lit<span class=nt>&lt;/with&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/query&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div></li><li>by time<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>type=</span><span class=s>&#39;get&#39;</span> <span class=na>id=</span><span class=s>&#39;juliet1&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;query</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;start&gt;</span>2010-06-07T00:00:00Z<span class=nt>&lt;/start&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;end&gt;</span>2010-07-07T13:23:54Z<span class=nt>&lt;/end&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/query&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div></li><li>by max number</li><li>by uid of message</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>type=</span><span class=s>&#39;get&#39;</span> <span class=na>id=</span><span class=s>&#39;q29303&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;query</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;start&gt;</span>2010-08-07T00:00:00Z<span class=nt>&lt;/start&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;set</span> <span class=na>xmlns=</span><span class=s>&#39;http://jabber.org/protocol/rsm&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>         <span class=nt>&lt;max&gt;</span>10<span class=nt>&lt;/max&gt;</span>
</span></span><span class=line><span class=cl>         <span class=nt>&lt;after&gt;</span>09af3-cc343-b409f<span class=nt>&lt;/after&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/set&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/query&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;message</span> <span class=na>id=</span><span class=s>&#39;aeb213&#39;</span> <span class=na>to=</span><span class=s>&#39;juliet@capulet.lit/chamber&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;result</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span> <span class=na>queryid=</span><span class=s>&#39;f27&#39;</span> <span class=na>id=</span><span class=s>&#39;28482-98726-73623&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;forwarded</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:forward:0&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;delay</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:delay&#39;</span> <span class=na>stamp=</span><span class=s>&#39;2010-07-10T23:08:25Z&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;message</span> <span class=na>to=</span><span class=s>&#39;juliet@capulet.lit/balcony&#39;</span>
</span></span><span class=line><span class=cl>        <span class=na>from=</span><span class=s>&#39;romeo@montague.lit/orchard&#39;</span>
</span></span><span class=line><span class=cl>        <span class=na>type=</span><span class=s>&#39;chat&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;body&gt;</span>Call me but love, and I&#39;ll be new baptized; Henceforth I never will be Romeo.<span class=nt>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/message&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/forwarded&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/message&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;message</span> <span class=na>id=</span><span class=s>&#39;aeb214&#39;</span> <span class=na>to=</span><span class=s>&#39;juliet@capulet.lit/chamber&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;result</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span> <span class=na>queryid=</span><span class=s>&#39;f27&#39;</span> <span class=na>id=</span><span class=s>&#39;5d398-28273-f7382&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;forwarded</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:forward:0&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;delay</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:delay&#39;</span> <span class=na>stamp=</span><span class=s>&#39;2010-07-10T23:09:32Z&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;message</span> <span class=na>to=</span><span class=s>&#39;romeo@montague.lit/orchard&#39;</span>
</span></span><span class=line><span class=cl>         <span class=na>from=</span><span class=s>&#39;juliet@capulet.lit/balcony&#39;</span>
</span></span><span class=line><span class=cl>         <span class=na>type=</span><span class=s>&#39;chat&#39;</span> <span class=na>id=</span><span class=s>&#39;8a54s&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;body&gt;</span>What man art thou that thus bescreen&#39;d in night so stumblest on my counsel?<span class=nt>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/message&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/forwarded&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/message&gt;</span>
</span></span></code></pre></div></li></ul><h4 id=3-preferences>3. Preferences</h4><ul><li><p>jid list</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl> <span class=nt>&lt;iq</span> <span class=na>type=</span><span class=s>&#39;set&#39;</span> <span class=na>id=</span><span class=s>&#39;juliet2&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;prefs</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span> <span class=na>default=</span><span class=s>&#39;roster&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;always&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;jid&gt;</span>romeo@montague.lit<span class=nt>&lt;/jid&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/always&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;never&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;jid&gt;</span>montague@montague.lit<span class=nt>&lt;/jid&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/never&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/prefs&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div><ul><li>option:<ul><li>always - all messages are archived by default.</li><li>never - messages are never archived by default.</li><li>roster - messages are archived only if the contact&rsquo;s bare JID is in the user&rsquo;s roster</li></ul></li><li>rules:<ul><li>outgoing - use &rsquo;to&rsquo; attribute</li><li>incomming - use &lsquo;from&rsquo; attribute</li><li>contains resource - compare</li><li>no resource - any resource</li></ul></li></ul></li><li><p>Ad-Hoc Commands<br><br><a href=http://xmpp.org/extensions/xep-0050.html>http://xmpp.org/extensions/xep-0050.html</a></p></li></ul><h4 id=4-security>4. Security</h4><ul><li>archived tag</li><li>only user authorized have permission</li><li>privacy</li></ul><h4 id=5-mongooseim-config-odbc>5. MongooseIM Config (odbc)</h4><ul><li><code>{mod_mam, []}</code><br>enable mam</li><li><code>{mod_mam_odbc_prefs, [pm]}</code><br>archiving preferences<br>pm : user-to-user messages<br>muc : multiple user</li><li><code>{mod_mam_odbc_user, [pm, muc]}</code><br>converting an archive id to an integer</li><li><code>{mod_mam_odbc_arch, [pm, muc]}</code><br>archiving message</li><li><code>mod_mam_odbc_async_writer</code><br>Asynchronous writer, will insert batches of messages.<br>option <code>no_writer</code> set in <code>mod_mam_odbc_arch</code></li></ul></div><div class=tags><ul class=info><li>2014-12-23</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li><li><a href=https://blog.caoyue.me/tags/ejabberd>#ejabberd</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2023 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch{}</script></div></footer></div></body></html>