<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="问题 先看下面一个简单的 ASP.NET MVC 5 的 demo：
  model
public class TestModel { public List<int> Ints { get; set; } }   controller
public ActionResult Index() { var testModel = new TestModel(); return View(testModel); } [ActionName(&#34;Index&#34;), HttpPost] public ActionResult Post(TestModel testModel) { return View(testModel); }   view
@model Test.Controllers.TestModel <form action=&#34;@Url.Action(&#34;Index&#34;)&#34; method=&#34;post&#34;> @for (var i = 0; i < 10; i++) { @Html.TextBoxFor(model => model.Ints[i]) } <input type=&#34;submit&#34; value=&#34;Submit&#34; /> </form>   有没有看出什么问题？"><meta name=author content="caoyue"><title>且听疯吟 / 一个 ASP.NET MVC HtmlHelper 的 tricks</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>一个 ASP.NET MVC HtmlHelper 的 tricks</div><div class=content><h3 id=问题>问题</h3><p>先看下面一个简单的 <code>ASP.NET MVC 5</code> 的 demo：</p><ul><li><p>model</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>TestModel</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>List</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span> <span class=n>Ints</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>controller</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=n>ActionResult</span> <span class=n>Index</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>testModel</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TestModel</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>View</span><span class=p>(</span><span class=n>testModel</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>[ActionName(&#34;Index&#34;), HttpPost]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>ActionResult</span> <span class=n>Post</span><span class=p>(</span><span class=n>TestModel</span> <span class=n>testModel</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>View</span><span class=p>(</span><span class=n>testModel</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>view</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>@model</span> <span class=n>Test</span><span class=p>.</span><span class=n>Controllers</span><span class=p>.</span><span class=n>TestModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=n>form</span> <span class=n>action</span><span class=p>=</span><span class=s>&#34;@Url.Action(&#34;</span><span class=n>Index</span><span class=s>&#34;)&#34;</span> <span class=n>method</span><span class=p>=</span><span class=s>&#34;post&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>@for</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>10</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>@Html</span><span class=p>.</span><span class=n>TextBoxFor</span><span class=p>(</span><span class=n>model</span> <span class=p>=&gt;</span> <span class=n>model</span><span class=p>.</span><span class=n>Ints</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>input</span> <span class=n>type</span><span class=p>=</span><span class=s>&#34;submit&#34;</span> <span class=k>value</span><span class=p>=</span><span class=s>&#34;Submit&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=n>form</span><span class=p>&gt;</span>
</span></span></code></pre></div></li></ul><p>有没有看出什么问题？<br><br><code>View</code> 里面的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>@for</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>10</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Html</span><span class=p>.</span><span class=n>TextBoxFor</span><span class=p>(</span><span class=n>model</span> <span class=p>=&gt;</span> <span class=n>model</span><span class=p>.</span><span class=n>Ints</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在 <code>Model.Ints</code> 并没有初始化的情况下被使用了。</p><p>正常情况下可能会这么写：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=err>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Model</span><span class=p>.</span><span class=n>Ints</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Model</span><span class=p>.</span><span class=n>Ints</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>Model</span><span class=p>.</span><span class=n>Ints</span><span class=p>.</span><span class=n>Count</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>@Html</span><span class=p>.</span><span class=n>TextBoxFor</span><span class=p>(</span><span class=n>model</span> <span class=p>=&gt;</span> <span class=n>model</span><span class=p>.</span><span class=n>Ints</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如果我们需要 10 个 <code>input</code>，可能还得费心给 <code>Model.Ints</code> 初始化并添加 10 个 元素。</p><p>然而前面的写法真的会报错吗？<br><br>其实并不会，it works well.</p><p>为什么呢？ <code>@Html.TextBoxFor(model => model.Ints[i])</code> 在 <code>Model.Ints</code> 并未初始化的时候就使用了，那么应该会抛出异常才对？</p><h3 id=原因>原因</h3><p>那么，我们来看看为什么没有报错。<br>这就要从源代码上找原因。</p><p>幸好，ASP.NET MVC 已经在 Github 上开源了，地址在<a href=https://github.com/ASP-NET-MVC/aspnetwebstack>这里</a></p><ul><li><p>我们很容易根据 namespace 找到 <code>Html.TextBoxFor</code> 的实现，参考 <a href=https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/Html/InputExtensions.cs#L425>https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/Html/InputExtensions.cs#L425</a></p></li><li><p>简略的说，根据方法签名追踪，可以找到 <code>InputHelper</code> 方法，即<a href=https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/Html/InputExtensions.cs#L483>https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/Html/InputExtensions.cs#L483</a></p></li><li><p>重点在这一段：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kt>string</span> <span class=n>attemptedValue</span> <span class=p>=</span> <span class=p>(</span><span class=kt>string</span><span class=p>)</span><span class=n>htmlHelper</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>GetModelStateValue</span><span class=p>(</span><span class=n>fullName</span><span class=p>,</span> <span class=k>typeof</span><span class=p>(</span><span class=kt>string</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=n>tagBuilder</span><span class=p>.</span><span class=n>MergeAttribute</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>,</span> <span class=n>attemptedValue</span> <span class=p>??</span> <span class=p>((</span><span class=n>useViewData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>?</span> <span class=n>htmlHelper</span><span class=p>.</span><span class=n>EvalString</span><span class=p>(</span><span class=n>fullName</span><span class=p>,</span> <span class=n>format</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>:</span> <span class=n>valueParameter</span><span class=p>),</span> <span class=n>isExplicitValue</span><span class=p>);</span>
</span></span></code></pre></div><p>如果要报错，那么应该报错在 <code>htmlHelper.GetModelStateValue</code>，因为很明显这是获取 <code>Model.Ints[i]</code> 的值的地方</p></li><li><p>继续找到 <code>HtmlHelper.GetModelStateValue</code> 方法，即 <a href=https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/HtmlHelper.cs#L391>https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/HtmlHelper.cs#L391</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>internal</span> <span class=kt>object</span> <span class=n>GetModelStateValue</span><span class=p>(</span><span class=kt>string</span> <span class=n>key</span><span class=p>,</span> <span class=n>Type</span> <span class=n>destinationType</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ModelState</span> <span class=n>modelState</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ViewData</span><span class=p>.</span><span class=n>ModelState</span><span class=p>.</span><span class=n>TryGetValue</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>out</span> <span class=n>modelState</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>modelState</span><span class=p>.</span><span class=n>Value</span> <span class=p>!=</span> <span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>modelState</span><span class=p>.</span><span class=n>Value</span><span class=p>.</span><span class=n>ConvertTo</span><span class=p>(</span><span class=n>destinationType</span><span class=p>,</span> <span class=k>null</span> <span class=cm>/* culture */</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>重点就在于 <code>ViewData.ModelState.TryGetValue</code> 了，显然 <code>ModelState</code> 主结构是一个 <code>Dictionary</code> 来存储所有的值，这个想必大部分人都知道，所以我们绕了一圈最终找到了这里<br>也就是说，实际上是通过 <code>Dictionary.TryGetValue(key, out value)</code> 这样的形式来获取对应的值<br>具体到我们的问题，即 <code>i == 0</code> 时，在 <code>ModelState</code> 中寻找 <code>key == "Ints[0]"</code> 的值，当然，其值为 null 并且并不会报错</p></li></ul><p>所以整个流程中并不会因为 <code>Model.Ints</code> 未初始化而报错，因为 <code>Html.TextBoxFor(model => model.Ints[i])</code> 并不是通过直接访问而是从 expression 数据结构和 ModelState 数据绑定中取值。虽然这背后机制并不复杂，但是这个问题突然冒出来的时候，没有完整看过这部分实现，我也并没有想到这其中的关联。</p><p>最后，<strong>在使用之前初始化一定是一个好习惯！</strong></p><h3 id=附送>附送</h3><p>其实比起看源码，通过 Visual Studio 来 debug 可能更方便。</p><p>那么步骤如下：</p><ul><li>找到 Tool -> Options -> Debugging -> General</li><li>Uncheck <code>Enable Just My Code</code></li><li>Check <code>Enable Source Server Support</code></li><li>转到 Tool -> Options -> Debugging -> Symbols</li><li>Check <code>Microsoft Symbol Servers</code></li><li>Add <code>http://referencesource.microsoft.com/symbols</code></li><li>Add <code>http://msdl.microsoft.com/download/symbols</code></li><li>Add <code>http://srv.symbolsource.org/pdb/Public</code></li><li>我也不知道哪个 symbol server 对你有效，所以就都加上吧~</li><li>如果你只需要一部分的 modules，可以选择 <code>Only specified modules</code>，比如添加 <code>System.Web.Mvc.dll</code></li></ul><p>接下来进入调试时，只要右键在当前断点上选择 <code>Step Into Specific</code> 就可以选择进入调试源码了~</p></div><div class=tags><ul class=info><li>2017-05-31</li><li><a href=https://blog.caoyue.me/tags/programming>#programming</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",''),document.querySelector("section.article.discussion").innerHTML='',document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2022 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch(e){}</script></div></footer></div></body></html>