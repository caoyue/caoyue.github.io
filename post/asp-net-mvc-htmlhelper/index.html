<html lang="zh"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="default"/><meta name="format-detection" content="telephone=no"/><meta name="theme-color" content="#a6d6d6"/><meta name="msapplication-TileColor" content="#a6d6d6"/><meta name="msapplication-TileImage" content="/icon/favicon.ico"/><meta name="referrer" content="no-referrer"/><title>且听疯吟 / 一个 ASP.NET MVC HtmlHelper 的 tricks</title><link rel="alternate" type="application/rss+xml" title="atom 1.0" href="/atom.xml"/><link rel="apple-touch-icon" sizes="192x192" href="/icon/favicon.ico"/><link rel="icon" type="image/png" sizes="48x48" href="/icon/favicon.ico"/><link rel="icon" type="image/png" sizes="192x192" href="/icon/favicon.ico"/><link rel="stylesheet" href="/css/normalize.css"/><link rel="stylesheet" href="/css/style.css"/><meta name="generator" content="Hexo 6.0.0"></head><body><div class="wrap"><div class="header"><a href="/" title="this is a link">且听疯吟</a><span>如此生活三十年</span></div><div class="left"><ul class="list"><li><a href="/" title="Home">Home</a></li><li><a href="/archives" title="archive">Archive</a></li><li><a href="/tags" title="Tags">Tags</a></li></ul></div><div class="right"><div class="entry" id="content"><div class="title">一个 ASP.NET MVC HtmlHelper 的 tricks</div><div class="content"><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>先看下面一个简单的 <code>ASP.NET MVC 5</code> 的 demo：</p>
<ul>
<li><p>model</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">int</span>&gt; Ints &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>controller</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> testModel = <span class="keyword">new</span> TestModel();</span><br><span class="line">    <span class="keyword">return</span> View(testModel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ActionName(<span class="meta-string">&quot;Index&quot;</span>), HttpPost</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Post</span>(<span class="params">TestModel testModel</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> View(testModel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>view</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@model Test.Controllers.TestModel</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;@Url.Action(&quot;</span>Index<span class="string">&quot;)&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    @for (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        @Html.TextBoxFor(model =&gt; model.Ints[i])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;Submit&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>有没有看出什么问题？<br/><br><code>View</code> 里面的</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@for (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    Html.TextBoxFor(model =&gt; model.Ints[i])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>Model.Ints</code> 并没有初始化的情况下被使用了。</p>
<p>正常情况下可能会这么写：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    <span class="keyword">if</span> (Model.Ints == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Model.Ints = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; Model.Ints.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        @Html.TextBoxFor(model =&gt; model.Ints[i])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们需要 10 个 <code>input</code>，可能还得费心给 <code>Model.Ints</code> 初始化并添加 10 个 元素。</p>
<p>然而前面的写法真的会报错吗？<br/><br>其实并不会，it works well.</p>
<p>为什么呢？ <code>@Html.TextBoxFor(model =&gt; model.Ints[i])</code> 在 <code>Model.Ints</code> 并未初始化的时候就使用了，那么应该会抛出异常才对？</p>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>那么，我们来看看为什么没有报错。<br>这就要从源代码上找原因。</p>
<p>幸好，ASP.NET MVC 已经在 Github 上开源了，地址在<a target="_blank" rel="noopener" href="https://github.com/ASP-NET-MVC/aspnetwebstack">这里</a></p>
<ul>
<li><p>我们很容易根据 namespace 找到 <code>Html.TextBoxFor</code> 的实现，参考 <a target="_blank" rel="noopener" href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/Html/InputExtensions.cs#L425">https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/Html/InputExtensions.cs#L425</a></p>
</li>
<li><p>简略的说，根据方法签名追踪，可以找到 <code>InputHelper</code> 方法，即<a target="_blank" rel="noopener" href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/Html/InputExtensions.cs#L483">https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/Html/InputExtensions.cs#L483</a></p>
</li>
<li><p>重点在这一段：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> attemptedValue = (<span class="built_in">string</span>)htmlHelper</span><br><span class="line">    .GetModelStateValue(fullName, <span class="keyword">typeof</span>(<span class="built_in">string</span>));</span><br><span class="line">tagBuilder.MergeAttribute(<span class="string">&quot;value&quot;</span>, attemptedValue ?? ((useViewData)</span><br><span class="line">    ? htmlHelper.EvalString(fullName, format)</span><br><span class="line">    : valueParameter), isExplicitValue);</span><br></pre></td></tr></table></figure>

<p>如果要报错，那么应该报错在 <code>htmlHelper.GetModelStateValue</code>，因为很明显这是获取 <code>Model.Ints[i]</code> 的值的地方</p>
</li>
<li><p>继续找到 <code>HtmlHelper.GetModelStateValue</code> 方法，即 <a target="_blank" rel="noopener" href="https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/HtmlHelper.cs#L391">https://github.com/ASP-NET-MVC/aspnetwebstack/blob/master/src/System.Web.Mvc/HtmlHelper.cs#L391</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="built_in">object</span> <span class="title">GetModelStateValue</span>(<span class="params"><span class="built_in">string</span> key, Type destinationType</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ModelState modelState;</span><br><span class="line">    <span class="keyword">if</span> (ViewData.ModelState.TryGetValue(key, <span class="keyword">out</span> modelState))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (modelState.Value != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> modelState.Value.ConvertTo(destinationType, <span class="literal">null</span> <span class="comment">/* culture */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点就在于 <code>ViewData.ModelState.TryGetValue</code> 了，显然 <code>ModelState</code> 主结构是一个 <code>Dictionary</code> 来存储所有的值，这个想必大部分人都知道，所以我们绕了一圈最终找到了这里<br>也就是说，实际上是通过 <code>Dictionary.TryGetValue(key, out value)</code> 这样的形式来获取对应的值<br>具体到我们的问题，即 <code>i == 0</code> 时，在 <code>ModelState</code> 中寻找 <code>key == &quot;Ints[0]&quot;</code> 的值，当然，其值为 null 并且并不会报错</p>
</li>
</ul>
<p>所以整个流程中并不会因为 <code>Model.Ints</code> 未初始化而报错，因为 <code>Html.TextBoxFor(model =&gt; model.Ints[i])</code> 并不是通过直接访问而是从 expression 数据结构和 ModelState 数据绑定中取值。虽然这背后机制并不复杂，但是这个问题突然冒出来的时候，没有完整看过这部分实现，我也并没有想到这其中的关联。</p>
<p>最后，<strong>在使用之前初始化一定是一个好习惯！</strong></p>
<h3 id="附送"><a href="#附送" class="headerlink" title="附送"></a>附送</h3><p>其实比起看源码，通过 Visual Studio 来 debug 可能更方便。</p>
<p>那么步骤如下：</p>
<ul>
<li>找到 Tool -&gt; Options -&gt; Debugging -&gt; General</li>
<li>Uncheck <code>Enable Just My Code</code></li>
<li>Check <code>Enable Source Server Support</code></li>
<li>转到 Tool -&gt; Options -&gt; Debugging -&gt; Symbols</li>
<li>Check <code>Microsoft Symbol Servers</code></li>
<li>Add <code>http://referencesource.microsoft.com/symbols</code></li>
<li>Add <code>http://msdl.microsoft.com/download/symbols</code></li>
<li>Add <code>http://srv.symbolsource.org/pdb/Public</code></li>
<li>我也不知道哪个 symbol server 对你有效，所以就都加上吧~</li>
<li>如果你只需要一部分的 modules，可以选择 <code>Only specified modules</code>，比如添加 <code>System.Web.Mvc.dll</code></li>
</ul>
<p>接下来进入调试时，只要右键在当前断点上选择 <code>Step Into Specific</code> 就可以选择进入调试源码了~</p>
</div><div><ul class="info"><li>posted on 2017-05-30<li><a href="/tags/programming/">#programming</a></li></li></ul></div></div><div id="disqus_thread"></div><script>var disqus_config = function () {
    this.page.url = "https://blog.caoyue.me/post/asp-net-mvc-htmlhelper/";
    this.page.identifier = "post/asp-net-mvc-htmlhelper/";
};

(function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://caoyue.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script></div><div class="footer"><div></div>©2021<a href="https://blog.caoyue.me"> 且听疯吟</a>. designed by<a href="https://caoyue.me" target="_blank"> caoyue</a>. powered by<a href="https://hexo.io/" target="_blank"> hexo</a></div><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
</div></body></html>