<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="这个问题之前很好解决，使用浏览器 plugin 即可。
但是随着 Chrome 和 Firefox 都先后放弃了 NPAPI plugin，这一方法也行不通了，而且很多人是很讨厌 plugin 的。
但是在默认禁止了 NPAPI 的 Chrome 版本，QQ 依然可以实现快速登录（一键登录），是怎么做到的呢？
原理 其实不难猜。既然不存在 plugin，无法以此来实现浏览器内和本地客户端的直接通信，那么排除其他的黑科技，有一种很简单的方法可以实现这个效果。
那就是在客户端开一个 Server，在浏览器里面请求这个地址。
理论上这样是可以实现的，至于 QQ 是不是用的这种方法，稍微验证下好了。
验证   找一个有 QQ 快速登陆的页面，比如 mail.qq.com
  登陆 QQ 客户端
  打开浏览器的 Developer Tools -> Network
  刷新页面，观察所有请求的 domain
  好明显，这就是我们要找的了
  完整请求 url 是这样的
https://localhost.ptlogin2.qq.com:4301/pt_get_uins?callback=ptui_getuins_CB&r=0.22949112393586502&pt_local_tk=-2027291081   看看这个请求的 Response Content
var var_sso_uin_list = [ { account: &#34;xxxxxx&#34;, client_type: 65793, face_index: 0, gender: 1, nickname: &#34;xxx&#34;, uin: &#34;xxx&#34;, uin_flag: xxxxx, }, ]; ptui_getuins_CB(var_sso_uin_list); 很明显是当前登录的用户信息"><meta name=author content="caoyue"><title>且听疯吟 / QQ 是怎么实现快速登录的</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>QQ 是怎么实现快速登录的</div><div class=content><p>这个问题之前很好解决，使用浏览器 plugin 即可。<br>但是随着 Chrome 和 Firefox 都先后放弃了 NPAPI plugin，这一方法也行不通了，而且很多人是很讨厌 plugin 的。<br>但是在默认禁止了 NPAPI 的 Chrome 版本，QQ 依然可以实现快速登录（一键登录），是怎么做到的呢？</p><h4 id=原理>原理</h4><p>其实不难猜。既然不存在 plugin，无法以此来实现浏览器内和本地客户端的直接通信，那么排除其他的黑科技，有一种很简单的方法可以实现这个效果。<br>那就是在客户端开一个 Server，在浏览器里面请求这个地址。<br>理论上这样是可以实现的，至于 QQ 是不是用的这种方法，稍微验证下好了。</p><h4 id=验证>验证</h4><ul><li><p>找一个有 QQ 快速登陆的页面，比如 <code>mail.qq.com</code></p></li><li><p>登陆 QQ 客户端</p></li><li><p>打开浏览器的 Developer Tools -> Network</p></li><li><p>刷新页面，观察所有请求的 domain</p></li><li><p>好明显，这就是我们要找的了</p><ul><li><p>完整请求 url 是这样的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://localhost.ptlogin2.qq.com:4301/pt_get_uins?callback=ptui_getuins_CB&amp;r=0.22949112393586502&amp;pt_local_tk=-2027291081
</span></span></code></pre></div></li><li><p>看看这个请求的 Response Content</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>var_sso_uin_list</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>account</span><span class=o>:</span> <span class=s2>&#34;xxxxxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>client_type</span><span class=o>:</span> <span class=mi>65793</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>face_index</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>gender</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>nickname</span><span class=o>:</span> <span class=s2>&#34;xxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>uin</span><span class=o>:</span> <span class=s2>&#34;xxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>uin_flag</span><span class=o>:</span> <span class=nx>xxxxx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>ptui_getuins_CB</span><span class=p>(</span><span class=nx>var_sso_uin_list</span><span class=p>);</span>
</span></span></code></pre></div><p>很明显是当前登录的用户信息</p></li><li><p>ping 一下这个请求的 domain<br>不出所料结果是 <code>127.0.0.1</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl>ping localhost.ptlogin2.qq.com
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: Pinging localhost.ptlogin2.qq.com [127.0.0.1] with 32 bytes of data</span>
</span></span></code></pre></div></li></ul></li><li><p>现在我们验证下是否是 QQ 开了这个 Server</p><ul><li><p>查看哪个程序占用了 <code>4301</code> 端口</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl>netstat -ano <span class=p>|</span> findstr <span class=s2>&#34;4301&#34;</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>:  TCP    127.0.0.1:4301   0.0.0.0:0   LISTENING   14516</span>
</span></span></code></pre></div></li><li><p>得到 pid 我们就可以看否是 QQ 在监听这个端口了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl>tasklist <span class=p>|</span> findstr <span class=s2>&#34;14516&#34;</span>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: QQ.exe  14516 Console   2     87,892 K</span>
</span></span></code></pre></div></li></ul></li></ul><h4 id=安全>安全</h4><p>可能有人担心会不会有安全问题，会不会其他网站访问这个 url 就拿走用户信息？其实挺容易解决，存一个 token 到服务端，获取的时候校验下就好了。<br>但是归根到底取决于腾讯对这方面安全的重视程度和意愿了，至少之前是确实存在从网页上获取当前登录的 QQ 信息的方法，虽然问题不是出在快速登录这部分。</p></div><div class=tags><ul class=info><li>2015-09-09</li><li><a href=https://blog.caoyue.me/tags/programming>#programming</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",''),document.querySelector("section.article.discussion").innerHTML='',document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2022 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch(e){}</script></div></footer></div></body></html>