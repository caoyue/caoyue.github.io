<!doctype html><html lang=zh-Hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="假设我们要实现一个炉石的对战机制，要怎么做呢？
并没有游戏开发经验，所以以下都是乱猜加瞎扯~
分类 首先，我们把炉石里的主要元素分成几类：
法术
法术很好理解，一般来说法术包括几个要素
目标 可能是一个目标也可能是多个目标 可能包含一个筛选，比如「对非恶魔随从造成伤害」 效果 可能是给目标一个 buff 或者 debuff，也可能是造成伤害等等 大部分法术都是立即效果 也有一部分法术是触发效果，比如 奥秘，比如 本回合随从生命值不会降低到 1 点以下 武器
英雄
英雄技能可以看作一个法术 随从
随从本身具有的属性
花费/攻击/血量 类别： 恶魔/鱼人/野兽 其他
我们以 https://hearthstonejson.com/ 上的卡牌火车王的 Json 数据为例： { &#34;id&#34;: &#34;EX1_116&#34;, &#34;name&#34;: &#34;Leeroy Jenkins&#34;, &#34;text&#34;: &#34;<b>Charge</b>. <b>Battlecry:</b> Summon two 1/1 Whelps for your opponent.&#34;, &#34;rarity&#34;: &#34;LEGENDARY&#34;, &#34;type&#34;: &#34;MINION&#34;, &#34;cost&#34;: 5, &#34;attack&#34;: 6, &#34;health&#34;: 2, &#34;collectible&#34;: true, &#34;set&#34;: &#34;EXPERT1&#34;, &#34;faction&#34;: &#34;ALLIANCE&#34;, &#34;artist&#34;: &#34;Gabe from Penny Arcade&#34;, &#34;flavor&#34;: &#34;At least he has Angry Chicken."><meta name=author content="caoyue"><title>且听疯吟 / 炉石卡牌实现机制的一点猜想</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>炉石卡牌实现机制的一点猜想</div><div class=content><p>假设我们要实现一个炉石的对战机制，要怎么做呢？<br>并没有游戏开发经验，所以以下都是乱猜加瞎扯~</p><h3 id=分类>分类</h3><p>首先，我们把炉石里的主要元素分成几类：</p><ul><li><p>法术<br>法术很好理解，一般来说法术包括几个要素</p><ul><li>目标<ul><li>可能是一个目标也可能是多个目标</li><li>可能包含一个筛选，比如「对非恶魔随从造成伤害」</li></ul></li><li>效果<ul><li>可能是给目标一个 buff 或者 debuff，也可能是造成伤害等等</li><li>大部分法术都是立即效果</li><li>也有一部分法术是触发效果，比如 <code>奥秘</code>，比如 <code>本回合随从生命值不会降低到 1 点以下</code></li></ul></li></ul></li><li><p>武器</p></li><li><p>英雄</p><ul><li>英雄技能可以看作一个法术</li></ul></li><li><p>随从</p><ul><li><p>随从本身具有的属性</p><ul><li>花费/攻击/血量</li><li>类别： 恶魔/鱼人/野兽</li><li>其他<br>我们以 <a href=https://hearthstonejson.com/>https://hearthstonejson.com/</a> 上的卡牌火车王的 Json 数据为例：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Json data-lang=Json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;EX1_116&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Leeroy Jenkins&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;b&gt;Charge&lt;/b&gt;. &lt;b&gt;Battlecry:&lt;/b&gt; Summon two 1/1 Whelps for your opponent.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;rarity&#34;</span><span class=p>:</span> <span class=s2>&#34;LEGENDARY&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;MINION&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cost&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;attack&#34;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;health&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;collectible&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;set&#34;</span><span class=p>:</span> <span class=s2>&#34;EXPERT1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;faction&#34;</span><span class=p>:</span> <span class=s2>&#34;ALLIANCE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;artist&#34;</span><span class=p>:</span> <span class=s2>&#34;Gabe from Penny Arcade&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;flavor&#34;</span><span class=p>:</span> <span class=s2>&#34;At least he has Angry Chicken.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mechanics&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;BATTLECRY&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CHARGE&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dust&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=mi>1600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>3200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>400</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>1600</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>随从效果</p><ul><li>即上面的 <code>mechanics</code> 数据</li><li>目前炉石包括了 <code>冲锋、亡语、发现、战吼、法术伤害、连击</code> 等等大概二十多种效果</li></ul></li></ul></li></ul><h3 id=效果>效果</h3><ul><li>法术效果<ul><li>法术效果相对来说容易归纳</li></ul></li><li>随从效果<ul><li>实际上随从效果可以认为是法术效果，比如自带亡语的随从，可以认为是通过法术给予了亡语效果——毕竟，炉石里面确实存在着这样的法术</li><li>具有亡语效果 <code>随机召唤一个法力消耗为 3 的随从</code> 的随从死亡时，可以认为是使用了一个 <code>随机召唤一个法力消耗为 3 的随从</code> 的法术</li><li>光环是一种特殊的法术效果，拥有更加复杂的触发条件，比如 <code>将你的治疗法术或技能改为造成等量的伤害</code></li></ul></li></ul><h3 id=对局>对局</h3><ul><li>从对局中我们可以总结出一些规则，比如大家经常会讨论的 <code>结算顺序</code><ul><li>虽然打出一张牌表面上看起来很简单，但是背后其实包括了多个阶段，比如：<ul><li>选择战吼目标并出牌，此时扣费</li><li>登场效果触发，这个时候一部分其他卡牌的效果已经会被触发，比如 <code>任务达人</code></li><li>召唤效果触发，比如会触发 <code>送葬者</code></li><li>战吼效果触发，此时开始结算战吼效果</li><li>奥秘效果触发，这也是为什么 <code>谢娜</code> 这张牌可以先偷到复制但是自己本身并不会被复制</li><li>召唤结束，这时会触发 <code>飞刀杂耍者</code> 之类的效果<br>（结算比较复杂，而且涉及到各种死亡结算和效果，而且暴雪也没有出官方的结算规则，所以，以上只是举个栗子~</li></ul></li></ul></li></ul><ul><li>从上面的例子可以看到，不同的牌在不同的阶段触发效果<br>假设我们需要实现一张 <code>飞刀杂耍者</code>，每召唤一个随从就发射一把飞刀<ul><li>我们可以很容易分开两个角色<ul><li>系统，它担任裁判的角色</li><li>卡牌<br>这样由系统去执行整个流程，在召唤了一个随从后，通知 <code>飞刀杂耍者</code> 去执行发射飞刀的任务</li></ul></li></ul></li><li>显然我们没办法把所有卡牌逻辑都塞在 <code>系统</code> 这个角色中，假设我们有 500 张卡牌，那么 <code>系统</code> 这部分的调用代码可能会突破天际</li><li>我们也不能让 <code>飞刀杂耍者</code> 自己去监控整场对局，从而决定什么时候发射飞刀，显然这样 <code>系统</code> 这个角色就失去了其意义，代码也会无比混乱</li><li>实际上对于这样的问题，我们有一个经典的例子（或许你在面试中已经被问了无数次的 「猫叫老鼠跑人醒」）<ul><li>这就是观察者模式（事件-通知）</li><li>我们只需要让 <code>飞刀杂耍者</code> 在 <code>系统</code> 那里注册一个事件，告诉它，有随从被召唤的时候，通知我，然后由我来执行对应的逻辑</li><li><code>系统</code> 则需要维护一个注册的事件列表，比如随从被召唤的事件、随从死亡的事件等等</li><li><code>系统</code> 按结算规则来执行，并在对应的事件触发的时候，按一定的顺序去通知即可</li></ul></li></ul><h3 id=其他>其他</h3><ul><li>炉石包含很多不同的效果，事实上这也正是它好玩的地方，但一来暴雪没有出明确的结算规则和效果解释，有些卡牌的效果也找不到同类和规律（比如改变战吼效果的 <code>铜须</code> 光环，和改变法术执行目标的 <code>扰咒术</code> 等等），所以有些时候想总结一套规则来套用所有卡牌不太容易</li><li>对于单个的特殊的效果，hardcode 也是一个解决办法</li></ul><h3 id=插件>插件</h3><p>额外插一点关于炉石插件的内容，之前看到有童鞋在好奇</p><ul><li>炉石传说有一个隐藏的 debug-logging 模式，打开之后会产生非常详细的记录，通过解析这个 log 可以做到记录和获取对局信息</li><li>网易的盒子貌似额外使用了抓包解析的方法，所以功能会强大一些，比如导入导出卡组的功能</li><li>但是考虑到可能触犯 ToS ，其他插件没有这么做</li><li>log 大概是这样的：<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Zone] ZoneChangeList.ProcessChanges() - id=1 local=False [name=Garrosh Hellscream id=4 zone=PLAY zonePos=0 cardId=HERO_01 player=1] zone from -&gt; FRIENDLY PLAY (Hero)
</span></span></code></pre></div><ul><li>可以看出 log 是非常详细的，包含各种事件的触发</li><li>解析完整的 log 可以帮助理解整个炉石的事件机制</li></ul></li><li>当初想要自己实现盒子的时候参考过这篇文章 <a href=https://www.reddit.com/r/hearthstone/comments/268fkk/simple_hearthstone_logging_see_your_complete_play>https://www.reddit.com/r/hearthstone/comments/268fkk/simple_hearthstone_logging_see_your_complete_play</a></li><li>当然现在很多开源的插件了，比如 <a href=https://github.com/HearthSim/Hearthstone-Deck-Tracker>https://github.com/HearthSim/Hearthstone-Deck-Tracker</a></li></ul><h3 id=待补充>待补充</h3><p>想到哪写到哪，有什么想法再补充吧 =-=</p></div><div class=tags><ul class=info><li>2016-05-31</li><li><a href=https://blog.caoyue.me/tags/programming>#programming</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2023 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch{}</script></div></footer></div></body></html>