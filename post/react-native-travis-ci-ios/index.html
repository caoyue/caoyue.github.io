<html lang="zh"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="default"/><meta name="format-detection" content="telephone=no"/><meta name="theme-color" content="#a6d6d6"/><meta name="msapplication-TileColor" content="#a6d6d6"/><meta name="msapplication-TileImage" content="/icon/favicon.ico"/><meta name="referrer" content="no-referrer"/><title>且听疯吟 / 使用 Travis CI 自动部署 React Native 项目 （iOS 篇）</title><link rel="alternate" type="application/rss+xml" title="atom 1.0" href="/atom.xml"/><link rel="apple-touch-icon" sizes="192x192" href="/icon/favicon.ico"/><link rel="icon" type="image/png" sizes="48x48" href="/icon/favicon.ico"/><link rel="icon" type="image/png" sizes="192x192" href="/icon/favicon.ico"/><link rel="stylesheet" href="/css/normalize.css"/><link rel="stylesheet" href="/css/style.css"/><meta name="generator" content="Hexo 6.0.0"></head><body><div class="wrap"><div class="header"><a href="/" title="this is a link">且听疯吟</a><span>如此生活三十年</span></div><div class="left"><ul class="list"><li><a href="/" title="Home">Home</a></li><li><a href="/archives" title="archive">Archive</a></li><li><a href="/tags" title="Tags">Tags</a></li></ul></div><div class="right"><div class="entry" id="content"><div class="title">使用 Travis CI 自动部署 React Native 项目 （iOS 篇）</div><div class="content"><p>编译、测试、打包、部署这一系列的操作实在是太麻烦而且容易出错漏，能自动化的东西我们就没必要手动去点。端着咖啡悠哉地等着叮的一声，安装包出现在面前，这才是我们想要的<br>花了点时间，把正在进行的 React Native 项目的自动部署完善了一下，实现了通过 Travis CI 自动编译测试，并打包成 ipa 发布到 FTP 的整个流程<br>现在只要 Push 到 Github 上，等到 Travis CI 运行完成，就直接可以拿到 ipa 包安装测试了</p>
<p>准备工作：<br>首先你需要一个 Github 账户<br>Travis CI 连接 Gtihub 后，会自动检查根目录下带有 <code>.travis.yml</code> 的项目<br>关于 Travis CI 的功能和文档，请参考 <a target="_blank" rel="noopener" href="https://docs.travis-ci.com/">https://docs.travis-ci.com/</a></p>
<p>这里给出一个 React Native 项目的 yml 文件示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">objective-c</span></span><br><span class="line"><span class="attr">osx_image:</span> <span class="string">xcode7.1</span></span><br><span class="line"><span class="attr">xcode_project:</span> <span class="string">ios/MyApp.xcodeproj</span></span><br><span class="line"><span class="attr">xcode_scheme:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">    <span class="attr">matrix:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SPEC=spec1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./scripts/decrypt_key.sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./scripts/add_key.sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">brew</span> <span class="string">update</span></span><br><span class="line"></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">brew</span> <span class="string">reinstall</span> <span class="string">node</span> <span class="string">flow</span> <span class="string">watchman</span> <span class="string">xctool</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">-g</span> <span class="string">react-native-cli</span></span><br><span class="line"></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line">    <span class="attr">only:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./scripts/release.sh</span></span><br></pre></td></tr></table></figure>

<h4 id="首先设置项目编译环境："><a href="#首先设置项目编译环境：" class="headerlink" title="首先设置项目编译环境："></a>首先设置项目编译环境：</h4><p>包括 <code>language</code> 和 要使用的编译镜像 <code>osx_image</code>，并指定项目文件和编译的 scheme</p>
<h4 id="证书加密："><a href="#证书加密：" class="headerlink" title="证书加密："></a>证书加密：</h4><p>由于 iOS 打包过程需要一些证书密钥，这些是无法公开 Push 到 Github 的<br>虽然 Travis CI 没有提供 security file 的功能，但是提供了一个 security 的环境变量的功能<br>因此，我们可以通过在本地加密证书然后上传，线上编译时再解开来实现这一目的</p>
<p>比如：</p>
<ul>
<li>Encrypt</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encrypt_key.sh</span></span><br><span class="line">openssl aes-256-cbc -k <span class="variable">$&#123;ENCRYPT_PASS&#125;</span> -<span class="keyword">in</span> scripts/MyAppdev.mobileprovision -out scripts/MyAppdev.mobileprovision.enc -a</span><br><span class="line">openssl aes-256-cbc -k <span class="variable">$&#123;ENCRYPT_PASS&#125;</span> -<span class="keyword">in</span> scripts/dist.cer -out scripts/dist.cer.enc -a</span><br><span class="line">openssl aes-256-cbc -k <span class="variable">$&#123;ENCRYPT_PASS&#125;</span> -<span class="keyword">in</span> scripts/dist.p12 -out scripts/dist.p12.enc -a</span><br></pre></td></tr></table></figure>

<ul>
<li>Decrypt</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># decrypt_key.sh</span></span><br><span class="line">openssl aes-256-cbc -k <span class="variable">$&#123;ENCRYPT_PASS&#125;</span> -<span class="keyword">in</span> scripts/MyAppdev.mobileprovision.enc -out scripts/MyAppdev.mobileprovision -d -a</span><br><span class="line">openssl aes-256-cbc -k <span class="variable">$&#123;ENCRYPT_PASS&#125;</span> -<span class="keyword">in</span> scripts/dist.cer.enc -out scripts/dist.cer -d -a</span><br><span class="line">openssl aes-256-cbc -k <span class="variable">$&#123;ENCRYPT_PASS&#125;</span> -<span class="keyword">in</span> scripts/dist.p12.enc -out scripts/dist.p12 -d -a</span><br></pre></td></tr></table></figure>

<p><strong>注意： 请不要直接上传你的证书和密钥！也不要把密码上传到公开的地方！</strong></p>
<h4 id="导入证书到-Travis-编译环境："><a href="#导入证书到-Travis-编译环境：" class="headerlink" title="导入证书到 Travis 编译环境："></a>导入证书到 Travis 编译环境：</h4><p>参考下面的步骤：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add_key.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a custom keychain</span></span><br><span class="line">security create-keychain -p travis ios-build.keychain</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make the custom keychain default, so xcodebuild will use it for signing</span></span><br><span class="line">security default-keychain -s ios-build.keychain</span><br><span class="line"></span><br><span class="line"><span class="comment"># Unlock the keychain</span></span><br><span class="line">security unlock-keychain -p travis ios-build.keychain</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set keychain timeout to 1 hour for long builds</span></span><br><span class="line"><span class="comment"># see http://www.egeek.me/2013/02/23/jenkins-and-xcode-user-interaction-is-not-allowed/</span></span><br><span class="line">security set-keychain-settings -t 3600 -l ~/Library/Keychains/ios-build.keychain</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add certificates to keychain and allow codesign to access them</span></span><br><span class="line">security import ./scripts/apple.cer -k ~/Library/Keychains/ios-build.keychain -T /usr/bin/codesign</span><br><span class="line">security import ./scripts/dist.cer -k ~/Library/Keychains/ios-build.keychain -T /usr/bin/codesign</span><br><span class="line">security import ./scripts/dist.p12 -k ~/Library/Keychains/ios-build.keychain -P <span class="variable">$KEY_PASS</span> -T /usr/bin/codesign</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Put the provisioning profile in place</span></span><br><span class="line">mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles</span><br><span class="line">cp <span class="string">&quot;./scripts/MyAppdev.mobileprovision&quot;</span> ~/Library/MobileDevice/Provisioning\ Profiles/</span><br></pre></td></tr></table></figure>

<h4 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h4><p>安装编译所需要的环境，比如 xctool、node、npm、react-native 等等</p>
<h4 id="编译和打包"><a href="#编译和打包" class="headerlink" title="编译和打包"></a>编译和打包</h4><p>举个栗子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># release.sh</span></span><br><span class="line"></span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line">react-native bundle --dev <span class="literal">false</span> --platform ios \</span><br><span class="line">    --bundle-output <span class="string">&quot;/tmp/main.jsbundle&quot;</span> --entry-file index.ios.js</span><br><span class="line"></span><br><span class="line">xctool -project ios/MyApp.xcodeproj -scheme MyApp build -sdk iphoneos \</span><br><span class="line">    configuration Release OBJROOT=<span class="variable">$PWD</span>/build SYMROOT=<span class="variable">$PWD</span>/build</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ $? != 0 ]];<span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; build failed&quot;</span></span><br><span class="line">     <span class="built_in">exit</span> 1;</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">PROVISIONING_PROFILE=<span class="string">&quot;<span class="variable">$HOME</span>/Library/MobileDevice/Provisioning Profiles/MyAppdev.mobileprovision&quot;</span></span><br><span class="line">OUTPUTDIR=<span class="string">&quot;<span class="variable">$PWD</span>/build/Release-iphoneos&quot;</span></span><br><span class="line">NAME=Esports_<span class="variable">$&#123;TRAVIS_COMMIT:0:6&#125;</span>.ipa</span><br><span class="line"></span><br><span class="line">xcrun -<span class="built_in">log</span> -sdk iphoneos PackageApplication <span class="string">&quot;<span class="variable">$OUTPUTDIR</span>/MyApp.app&quot;</span> \</span><br><span class="line">    -o <span class="string">&quot;<span class="variable">$OUTPUTDIR</span>/<span class="variable">$NAME</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ $? != 0 ]];<span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; package application failed&quot;</span></span><br><span class="line">     <span class="built_in">exit</span> 1;</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$OUTPUTDIR</span></span><br><span class="line">curl --ftp-create-dirs -T <span class="string">&quot;<span class="variable">$NAME</span>&quot;</span> -u <span class="variable">$FTP_USER</span>:<span class="variable">$FTP_PASSWORD</span> \</span><br><span class="line">    ftp://<span class="variable">$FTP_SERVER</span>/esports/<span class="variable">$NAME</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; &#123;<span class="variable">$NAME</span>&#125; uploaded!&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; all done!&quot;</span></span><br></pre></td></tr></table></figure>

<p>基本上和本地编译运行 React Native 项目类似，不同之处在于使用了 xctool 命令行来编译</p>
<ul>
<li>首先安装依赖 package</li>
<li>然后 react-native bundle （如果使用 online 的模式，可以忽略这一步）</li>
<li>使用 xctool 编译和测试项目</li>
<li>打包 App 为 ipa 文件</li>
<li>FTP 发布（Travis CI 支持多种发布方式，可以参考文档实现）</li>
<li>完成，邮件或 IM 通知（如果你需要）</li>
</ul>
<hr>
<p>ref: <a target="_blank" rel="noopener" href="https://www.objc.io/issues/6-build-tools/travis-ci/">https://www.objc.io/issues/6-build-tools/travis-ci/</a></p>
</div><div><ul class="info"><li>posted on 2016-03-09<li><a href="/tags/programming/">#programming</a></li><li><a href="/tags/react/">#react</a></li></li></ul></div></div><div id="disqus_thread"></div><script>var disqus_config = function () {
    this.page.url = "https://blog.caoyue.me/post/react-native-travis-ci-ios/";
    this.page.identifier = "post/react-native-travis-ci-ios/";
};

(function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://caoyue.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script></div><div class="footer"><div></div>©2021<a href="https://blog.caoyue.me"> 且听疯吟</a>. designed by<a href="https://caoyue.me" target="_blank"> caoyue</a>. powered by<a href="https://hexo.io/" target="_blank"> hexo</a></div><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
</div></body></html>