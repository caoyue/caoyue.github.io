<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="编译、测试、打包、部署这一系列的操作实在是太麻烦而且容易出错漏，能自动化的东西我们就没必要手动去点。端着咖啡悠哉地等着叮的一声，安装包出现在面前，这才是我们想要的
花了点时间，把正在进行的 React Native 项目的自动部署完善了一下，实现了通过 Travis CI 自动编译测试，并打包成 ipa 发布到 FTP 的整个流程
现在只要 Push 到 Github 上，等到 Travis CI 运行完成，就直接可以拿到 ipa 包安装测试了
准备工作：
首先你需要一个 Github 账户
Travis CI 连接 Gtihub 后，会自动检查根目录下带有 .travis.yml 的项目
关于 Travis CI 的功能和文档，请参考 https://docs.travis-ci.com/
这里给出一个 React Native 项目的 yml 文件示例：
language:objective-cosx_image:xcode7.1xcode_project:ios/MyApp.xcodeprojxcode_scheme:MyAppenv:matrix:- SPEC=spec1before_install:- ./scripts/decrypt_key.sh- ./scripts/add_key.sh- brew updateinstall:- brew reinstall node flow watchman xctool- npm install -g react-native-clibranches:only:- masterscript:- ./scripts/release.sh首先设置项目编译环境： 包括 language 和 要使用的编译镜像 osx_image，并指定项目文件和编译的 scheme
证书加密： 由于 iOS 打包过程需要一些证书密钥，这些是无法公开 Push 到 Github 的"><meta name=author content="caoyue"><title>且听疯吟 / 使用 Travis CI 自动部署 React Native 项目 （iOS 篇）</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>使用 Travis CI 自动部署 React Native 项目 （iOS 篇）</div><div class=content><p>编译、测试、打包、部署这一系列的操作实在是太麻烦而且容易出错漏，能自动化的东西我们就没必要手动去点。端着咖啡悠哉地等着叮的一声，安装包出现在面前，这才是我们想要的<br>花了点时间，把正在进行的 React Native 项目的自动部署完善了一下，实现了通过 Travis CI 自动编译测试，并打包成 ipa 发布到 FTP 的整个流程<br>现在只要 Push 到 Github 上，等到 Travis CI 运行完成，就直接可以拿到 ipa 包安装测试了</p><p>准备工作：<br>首先你需要一个 Github 账户<br>Travis CI 连接 Gtihub 后，会自动检查根目录下带有 <code>.travis.yml</code> 的项目<br>关于 Travis CI 的功能和文档，请参考 <a href=https://docs.travis-ci.com/>https://docs.travis-ci.com/</a></p><p>这里给出一个 React Native 项目的 yml 文件示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>language</span><span class=p>:</span><span class=w> </span><span class=l>objective-c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>osx_image</span><span class=p>:</span><span class=w> </span><span class=l>xcode7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>xcode_project</span><span class=p>:</span><span class=w> </span><span class=l>ios/MyApp.xcodeproj</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>xcode_scheme</span><span class=p>:</span><span class=w> </span><span class=l>MyApp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matrix</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>SPEC=spec1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>before_install</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>./scripts/decrypt_key.sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>./scripts/add_key.sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>brew update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>install</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>brew reinstall node flow watchman xctool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>npm install -g react-native-cli</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>branches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>only</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>./scripts/release.sh</span><span class=w>
</span></span></span></code></pre></div><h4 id=首先设置项目编译环境>首先设置项目编译环境：</h4><p>包括 <code>language</code> 和 要使用的编译镜像 <code>osx_image</code>，并指定项目文件和编译的 scheme</p><h4 id=证书加密>证书加密：</h4><p>由于 iOS 打包过程需要一些证书密钥，这些是无法公开 Push 到 Github 的<br>虽然 Travis CI 没有提供 security file 的功能，但是提供了一个 security 的环境变量的功能<br>因此，我们可以通过在本地加密证书然后上传，线上编译时再解开来实现这一目的</p><p>比如：</p><ul><li>Encrypt</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># encrypt_key.sh</span>
</span></span><span class=line><span class=cl>openssl aes-256-cbc -k <span class=si>${</span><span class=nv>ENCRYPT_PASS</span><span class=si>}</span> -in scripts/MyAppdev.mobileprovision -out scripts/MyAppdev.mobileprovision.enc -a
</span></span><span class=line><span class=cl>openssl aes-256-cbc -k <span class=si>${</span><span class=nv>ENCRYPT_PASS</span><span class=si>}</span> -in scripts/dist.cer -out scripts/dist.cer.enc -a
</span></span><span class=line><span class=cl>openssl aes-256-cbc -k <span class=si>${</span><span class=nv>ENCRYPT_PASS</span><span class=si>}</span> -in scripts/dist.p12 -out scripts/dist.p12.enc -a
</span></span></code></pre></div><ul><li>Decrypt</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># decrypt_key.sh</span>
</span></span><span class=line><span class=cl>openssl aes-256-cbc -k <span class=si>${</span><span class=nv>ENCRYPT_PASS</span><span class=si>}</span> -in scripts/MyAppdev.mobileprovision.enc -out scripts/MyAppdev.mobileprovision -d -a
</span></span><span class=line><span class=cl>openssl aes-256-cbc -k <span class=si>${</span><span class=nv>ENCRYPT_PASS</span><span class=si>}</span> -in scripts/dist.cer.enc -out scripts/dist.cer -d -a
</span></span><span class=line><span class=cl>openssl aes-256-cbc -k <span class=si>${</span><span class=nv>ENCRYPT_PASS</span><span class=si>}</span> -in scripts/dist.p12.enc -out scripts/dist.p12 -d -a
</span></span></code></pre></div><p><strong>注意： 请不要直接上传你的证书和密钥！也不要把密码上传到公开的地方！</strong></p><h4 id=导入证书到-travis-编译环境>导入证书到 Travis 编译环境：</h4><p>参考下面的步骤：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># add_key.sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a custom keychain</span>
</span></span><span class=line><span class=cl>security create-keychain -p travis ios-build.keychain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make the custom keychain default, so xcodebuild will use it for signing</span>
</span></span><span class=line><span class=cl>security default-keychain -s ios-build.keychain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Unlock the keychain</span>
</span></span><span class=line><span class=cl>security unlock-keychain -p travis ios-build.keychain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set keychain timeout to 1 hour for long builds</span>
</span></span><span class=line><span class=cl><span class=c1># see http://www.egeek.me/2013/02/23/jenkins-and-xcode-user-interaction-is-not-allowed/</span>
</span></span><span class=line><span class=cl>security set-keychain-settings -t <span class=m>3600</span> -l ~/Library/Keychains/ios-build.keychain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Add certificates to keychain and allow codesign to access them</span>
</span></span><span class=line><span class=cl>security import ./scripts/apple.cer -k ~/Library/Keychains/ios-build.keychain -T /usr/bin/codesign
</span></span><span class=line><span class=cl>security import ./scripts/dist.cer -k ~/Library/Keychains/ios-build.keychain -T /usr/bin/codesign
</span></span><span class=line><span class=cl>security import ./scripts/dist.p12 -k ~/Library/Keychains/ios-build.keychain -P <span class=nv>$KEY_PASS</span> -T /usr/bin/codesign
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Put the provisioning profile in place</span>
</span></span><span class=line><span class=cl>mkdir -p ~/Library/MobileDevice/Provisioning<span class=se>\ </span>Profiles
</span></span><span class=line><span class=cl>cp <span class=s2>&#34;./scripts/MyAppdev.mobileprovision&#34;</span> ~/Library/MobileDevice/Provisioning<span class=se>\ </span>Profiles/
</span></span></code></pre></div><h4 id=安装环境>安装环境</h4><p>安装编译所需要的环境，比如 xctool、node、npm、react-native 等等</p><h4 id=编译和打包>编译和打包</h4><p>举个栗子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># release.sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>npm install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>react-native bundle --dev <span class=nb>false</span> --platform ios <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --bundle-output <span class=s2>&#34;/tmp/main.jsbundle&#34;</span> --entry-file index.ios.js
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>xctool -project ios/MyApp.xcodeproj -scheme MyApp build -sdk iphoneos <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    configuration Release <span class=nv>OBJROOT</span><span class=o>=</span><span class=nv>$PWD</span>/build <span class=nv>SYMROOT</span><span class=o>=</span><span class=nv>$PWD</span>/build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=nv>$?</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>     <span class=nb>echo</span> <span class=s2>&#34;&gt;&gt; build failed&#34;</span>
</span></span><span class=line><span class=cl>     <span class=nb>exit</span> 1<span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>PROVISIONING_PROFILE</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/Library/MobileDevice/Provisioning Profiles/MyAppdev.mobileprovision&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>OUTPUTDIR</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$PWD</span><span class=s2>/build/Release-iphoneos&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>NAME</span><span class=o>=</span>Esports_<span class=si>${</span><span class=nv>TRAVIS_COMMIT</span><span class=p>:</span><span class=nv>0</span><span class=p>:</span><span class=nv>6</span><span class=si>}</span>.ipa
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>xcrun -log -sdk iphoneos PackageApplication <span class=s2>&#34;</span><span class=nv>$OUTPUTDIR</span><span class=s2>/MyApp.app&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -o <span class=s2>&#34;</span><span class=nv>$OUTPUTDIR</span><span class=s2>/</span><span class=nv>$NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=nv>$?</span> !<span class=o>=</span> <span class=m>0</span> <span class=o>]]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>     <span class=nb>echo</span> <span class=s2>&#34;&gt;&gt; package application failed&#34;</span>
</span></span><span class=line><span class=cl>     <span class=nb>exit</span> 1<span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$OUTPUTDIR</span>
</span></span><span class=line><span class=cl>curl --ftp-create-dirs -T <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2>&#34;</span> -u <span class=nv>$FTP_USER</span>:<span class=nv>$FTP_PASSWORD</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ftp://<span class=nv>$FTP_SERVER</span>/esports/<span class=nv>$NAME</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&gt;&gt; {</span><span class=nv>$NAME</span><span class=s2>} uploaded!&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&gt;&gt; all done!&#34;</span>
</span></span></code></pre></div><p>基本上和本地编译运行 React Native 项目类似，不同之处在于使用了 xctool 命令行来编译</p><ul><li>首先安装依赖 package</li><li>然后 react-native bundle （如果使用 online 的模式，可以忽略这一步）</li><li>使用 xctool 编译和测试项目</li><li>打包 App 为 ipa 文件</li><li>FTP 发布（Travis CI 支持多种发布方式，可以参考文档实现）</li><li>完成，邮件或 IM 通知（如果你需要）</li></ul><hr><p>ref: <a href=https://www.objc.io/issues/6-build-tools/travis-ci/>https://www.objc.io/issues/6-build-tools/travis-ci/</a></p></div><div class=tags><ul class=info><li>2016-03-09</li><li><a href=https://blog.caoyue.me/tags/react>#react</a></li><li><a href=https://blog.caoyue.me/tags/programming>#programming</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",''),document.querySelector("section.article.discussion").innerHTML='',document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2022 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch(e){}</script></div></footer></div></body></html>