<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="最近的项目需要做一个跨平台的 IM 服务，想要参考下其他项目的架构。国内分享不多，微信基本没有参考价值，毕竟 QQ 的积累在那。陌陌从招聘及据网上抓包的内容看是 XMPP 协议，看起来可能是 Java 的 openfire 之类的 XMPP 路线。
国外的分享稍微多一些，像 WhatsApp 每年都会做一些相关的分享，看起来有些参考价值。
WhatsApp 目前的数据 月用户约为 4.65 亿 每天有 190 亿 消息进站/ 400 亿消息出站 6 亿图片,2 亿音频, 1 亿视频 峰值并发连接为 1.47 亿 消息峰值为每秒 34.2 万进站/ 71.2 万出站 节日期间流量更加惊人 支撑这些数据的硬件 约 550 台服务器 约 150 台 chat server, 可以支持 1.5 亿连接 约 250 台 mms 服务器 数据服务器内存为 512 GB，标准节点是 64 GB 除了视频，其他数据都存储在 SSD 上 超过 11000 个核心 Mnesia 使用了约 2TB 的内存 服务端架构 几乎全部使用 Erlang (经过了自己的改造) 服务器使用的是 FreeBSD 9."><meta name=author content="caoyue"><title>且听疯吟 / WhatsApp 的一点分析</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>WhatsApp 的一点分析</div><div class=content><p>最近的项目需要做一个跨平台的 IM 服务，想要参考下其他项目的架构。国内分享不多，微信基本没有参考价值，毕竟 QQ 的积累在那。陌陌从招聘及据网上抓包的内容看是 XMPP 协议，看起来可能是 Java 的 openfire 之类的 XMPP 路线。<br>国外的分享稍微多一些，像 WhatsApp 每年都会做一些相关的分享，看起来有些参考价值。</p><h3 id=whatsapp-目前的数据>WhatsApp 目前的数据</h3><ul><li>月用户约为 4.65 亿</li><li>每天有 190 亿 消息进站/ 400 亿消息出站</li><li>6 亿图片,2 亿音频, 1 亿视频</li><li>峰值并发连接为 1.47 亿</li><li>消息峰值为每秒 34.2 万进站/ 71.2 万出站</li><li>节日期间流量更加惊人</li></ul><h3 id=支撑这些数据的硬件>支撑这些数据的硬件</h3><ul><li>约 550 台服务器</li><li>约 150 台 chat server, 可以支持 1.5 亿连接</li><li>约 250 台 mms 服务器</li><li>数据服务器内存为 512 GB，标准节点是 64 GB</li><li>除了视频，其他数据都存储在 SSD 上</li><li>超过 11000 个核心</li><li>Mnesia 使用了约 2TB 的内存</li></ul><h3 id=服务端架构>服务端架构</h3><ul><li>几乎全部使用 Erlang (经过了自己的改造)</li><li>服务器使用的是 FreeBSD 9.2</li><li>数据库是 Mnesia</li><li>ejabberd (做了大量改造，包括使用自己的协议替代 XMPP)</li><li>Yaws, lighttpd</li><li>非常重视性能监控</li></ul><h3 id=erlang>Erlang</h3><ul><li>大约 10 人的 Erlang 团队，工作包括开发和 ops</li><li>服务端基本全部使用 Erlang 开发</li><li>据说 Facebook Chat 开始也想要使用 Erlang ，但是由于优秀的 Erlang 工程师太难找而放弃了。不知真假，但是使用 Erlang 的好像的确不多。<br></li><li>团队对 Erlang 和 ejabberd 做了大量优化以满足越来越高的要求。但是在初期 Erlang 的表现就已经很好了</li><li>选择 Erlang 的原因是：<br><ul><li>只用很少的服务器就支撑起如此庞大的活跃用户，团队认为这归功于 Erlang</li><li>在 SMP 上的优秀扩展性</li><li>支持热更新</li></ul></li></ul><h3 id=ejabberd>ejabberd</h3><ul><li>最初从 ejabberd 开始</li><li>选择 ejabberd 是因为这是个非常优秀的开源 jabber 服务器</li><li>而且 ejabberd 是用 Erlang 写的</li><li>持续的对 ejabberd 进行重写和修改，包括从 XMPP 转换到内部开发协议、调整代码库以及重设计一些核心组件，并对 Erlang VM 做了大量的修改以获得高性能 Whats</li></ul><p>当年 WhatsApp 创始人去 Facebook 等企业求职被拒，据说原因之一是——年龄太大了。但也许只有老程序员才能坚持使用 Erlang 构建整个服务，并且用丰富的经验支撑起了整个 WhatsApp 庞大的架构——虽然主要是为了 WhatsApp 的庞大用户量而不单单是为了技术，Facebook 依然付出了 190 亿美元的代价。</p></div><div class=tags><ul class=info><li>2014-08-01</li><li><a href=https://blog.caoyue.me/tags/ejabberd>#ejabberd</a></li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2023 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch{}</script></div></footer></div></body></html>