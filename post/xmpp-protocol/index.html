<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="XMPP 协议 XMPP 协议是一种基于 XML 的 IM 协议，其前身是 jabber，后来被 IETF 标准化。其他信息可以参考 wikipedia.
协议架构 通过 TCP socket 与 XMPP 服务器进行通信 传输的是预定格式的 XML 信息 通过解析 XML 提取请求类型和消息 消息格式 一个实体在 XMPP 网络中被称为一个节点，它有唯一的标示符 jabber identifier (JID)，实体可以是用户或者聊天室
XMPP 中定义了 3 个顶层元素： Message、Presence、IQ
Message
基本的消息通讯格式：
To：消息的接收方 from : 发送方的 JID body: 要发送的消息 type: normal：单纯的消息，不要求响应； chat：IM 消息 groupchat：聊天室 group chat headline：发送 alert 和 notification 消息 error：发送 message 出错时通知 <message from='nobody@caoyue.me/test' to='anybody@caoyue.me' type='chat'> <body>Anybody?</body> </message> Presence
用来表明用户的状态，如：online、away、dnd (请勿打扰)等。"><meta name=author content="caoyue"><title>且听疯吟 / XMPP protocol</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>XMPP protocol</div><div class=content><h3 id=xmpp-协议>XMPP 协议</h3><p>XMPP 协议是一种基于 XML 的 IM 协议，其前身是 jabber，后来被 IETF 标准化。其他信息可以参考 <a href=http://en.wikipedia.org/wiki/XMPP>wikipedia</a>.</p><h4 id=协议架构>协议架构</h4><ul><li>通过 TCP socket 与 XMPP 服务器进行通信</li><li>传输的是预定格式的 XML 信息</li><li>通过解析 XML 提取请求类型和消息</li></ul><h4 id=消息格式>消息格式</h4><ul><li><p>一个实体在 XMPP 网络中被称为一个节点，它有唯一的标示符 jabber identifier (JID)，实体可以是用户或者聊天室</p></li><li><p>XMPP 中定义了 3 个顶层元素： <code>Message</code>、<code>Presence</code>、<code>IQ</code></p><ul><li><p>Message<br><br>基本的消息通讯格式：<br></p><ul><li>To：消息的接收方</li><li>from : 发送方的 JID</li><li>body: 要发送的消息</li><li>type:<br><ul><li>normal：单纯的消息，不要求响应；</li><li>chat：IM 消息</li><li>groupchat：聊天室 group chat</li><li>headline：发送 alert 和 notification 消息</li><li>error：发送 message 出错时通知</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-XML data-lang=XML><span class=line><span class=cl><span class=nt>&lt;message</span> <span class=na>from=</span><span class=s>&#39;nobody@caoyue.me/test&#39;</span>
</span></span><span class=line><span class=cl> <span class=na>to=</span><span class=s>&#39;anybody@caoyue.me&#39;</span> <span class=na>type=</span><span class=s>&#39;chat&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;body&gt;</span>Anybody?<span class=nt>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/message&gt;</span>
</span></span></code></pre></div></li><li><p>Presence<br><br>用来表明用户的状态，如：online、away、dnd (请勿打扰)等。<br>当用户离线或改变自己的状态时，就会在 stream 的上下文中插入一个 Presence 元素，来表明自身的状态。要想接受 presence 消息，必须经过一个叫做 presence subscription 的授权过程。</p><ul><li>type: 非必须<br><ul><li>subscribe：订阅其他用户的状态</li><li>probe：请求获取其他用户的状态</li><li>unavailable：不可用，offline</li></ul></li><li>show: 用户当前状态<ul><li>chat：聊天中</li><li>away：暂离</li><li>xa：eXtend Away，长时间离开</li><li>dnd：请勿打扰</li></ul></li><li>status：自由文本，即 rich presence 或 extended presence</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-XML data-lang=XML><span class=line><span class=cl><span class=nt>&lt;presence</span> <span class=na>from=</span><span class=s>&#39;nobody@caoyue.me/test&#39;</span> <span class=na>xml:lang=</span><span class=s>&#39;en&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;show&gt;</span>dnd<span class=nt>&lt;/show&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;status&gt;</span>Busy!<span class=nt>&lt;/status&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/presence&gt;</span>
</span></span></code></pre></div></li><li><p>IQ (Info/Query)<br>请求／响应消息，如获取用户的好友列表。</p><ul><li>type:<ul><li>get: 获取一个值</li><li>set: 设置或替换 get 查询的值</li><li>result: 服务器响应了先前的查询，返回结果如好友列表</li><li>error: 请求或响应出现错误</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-XML data-lang=XML><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>from=</span><span class=s>&#39;nobody@caoyue.me/test&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>id=</span><span class=s>&#39;xxxxxx&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>to=</span><span class=s>&#39;test&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>type=</span><span class=s>&#39;subscribe&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ping</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:ping&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>from=</span><span class=s>&#39;test&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>id=</span><span class=s>&#39;xxxxxx&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>to=</span><span class=s>&#39;nobody@caoyue.me/test&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>type=</span><span class=s>&#39;error&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;error</span> <span class=na>type=</span><span class=s>&#39;modify&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>       <span class=nt>&lt;bad-request</span> <span class=na>xmlns=</span><span class=s>&#39;urn:ietf:params:xml:ns:xmpp-stanzas&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/error&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div></li></ul></li></ul><p>Ref:<br>[1] <a href=http://xmpp.org/rfcs/rfc6120.html>http://xmpp.org/rfcs/rfc6120.html</a><br>[2] <a href=http://en.wikipedia.org/wiki/XMPP>http://en.wikipedia.org/wiki/XMPP</a></p></div><div class=tags><ul class=info><li>2014-08-05</li><li><a href=https://blog.caoyue.me/tags/ejabberd>#ejabberd</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2023 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch{}</script></div></footer></div></body></html>