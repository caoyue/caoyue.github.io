<!doctype html><html lang=zh-Hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="主要是通过 hook ejabberd 的离线消息处理，从而实现针对离线消息进行推送
1. Hook offline message 记录 device token
这一步没啥好说的，iOS 连接到 APNs 后获取到 device token，发给服务器，服务器负责维护好对应关系即可。
注意客户端退出时清理掉相应记录。
在 ejabberd 中新增一个模块，注册 offline_message_hook，大致如下：
start(Host, Opts) -> ?INFO_MSG(&#34;Starting mod_push_service&#34;, []), register(?MODULE, spawn(?MODULE, init, [Host, Opts])), ok. init(Host, _Opts) -> ejabberd_hooks:add(offline_message_hook, Host, ?MODULE, send_notification, 10), ok. stop(Host) -> ?INFO_MSG(&#34;Stopping mod_push_service&#34;, []), ejabberd_hooks:delete(offline_message_hook, Host, ?MODULE, send_notification, 10), ok. send_notification(From, To, Packet) -> dosomething. 2. Implement APNs 从 Apple 获取推送证书
在服务端使用该证书建立 ssl 连接
按照 Apple 文档生成指定格式的 Payload 并发送"><meta name=author content="caoyue"><title>且听疯吟 / ejabberd: Apple Push Notification Service</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>ejabberd: Apple Push Notification Service</div><div class=content><p>主要是通过 hook ejabberd 的离线消息处理，从而实现针对离线消息进行推送</p><h4 id=1-hook-offline-message>1. Hook offline message</h4><ul><li><p>记录 device token<br>这一步没啥好说的，iOS 连接到 APNs 后获取到 device token，发给服务器，服务器负责维护好对应关系即可。<br>注意客户端退出时清理掉相应记录。</p></li><li><p>在 ejabberd 中新增一个模块，注册 <code>offline_message_hook</code>，大致如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>start</span><span class=p>(</span><span class=nv>Host</span><span class=p>,</span> <span class=nv>Opts</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl><span class=o>?</span><span class=nv>INFO_MSG</span><span class=p>(</span><span class=s>&#34;Starting mod_push_service&#34;</span><span class=p>,</span> <span class=p>[]),</span>
</span></span><span class=line><span class=cl><span class=nb>register</span><span class=p>(</span><span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=nb>spawn</span><span class=p>(</span><span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=n>init</span><span class=p>,</span> <span class=p>[</span><span class=nv>Host</span><span class=p>,</span> <span class=nv>Opts</span><span class=p>])),</span>
</span></span><span class=line><span class=cl><span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>init</span><span class=p>(</span><span class=nv>Host</span><span class=p>,</span> <span class=p>_</span><span class=nv>Opts</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nn>ejabberd_hooks</span><span class=p>:</span><span class=nf>add</span><span class=p>(</span><span class=n>offline_message_hook</span><span class=p>,</span> <span class=nv>Host</span><span class=p>,</span> <span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=n>send_notification</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>stop</span><span class=p>(</span><span class=nv>Host</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span><span class=nv>INFO_MSG</span><span class=p>(</span><span class=s>&#34;Stopping mod_push_service&#34;</span><span class=p>,</span> <span class=p>[]),</span>
</span></span><span class=line><span class=cl>    <span class=nn>ejabberd_hooks</span><span class=p>:</span><span class=nf>delete</span><span class=p>(</span><span class=n>offline_message_hook</span><span class=p>,</span> <span class=nv>Host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=n>send_notification</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>send_notification</span><span class=p>(</span><span class=nv>From</span><span class=p>,</span> <span class=nv>To</span><span class=p>,</span> <span class=nv>Packet</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>dosomething</span><span class=p>.</span>
</span></span></code></pre></div></li></ul><h4 id=2-implement-apns>2. Implement APNs</h4><ul><li><p>从 Apple 获取推送证书</p></li><li><p>在服务端使用该证书建立 ssl 连接</p></li><li><p>按照 Apple 文档生成指定格式的 Payload 并发送</p></li><li><p>Apple 同时提供了 feedback channel 来获取失效 token 便于服务端获取记录，实现方式和发送消息类似，区别在于一个是发送消息，一个是接收消息</p></li><li><p>连接的粗略代码如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=p>-</span><span class=ni>module</span><span class=p>(</span><span class=n>apntest</span><span class=p>).</span>
</span></span><span class=line><span class=cl><span class=p>-</span><span class=ni>export</span><span class=p>([</span><span class=n>connect</span><span class=o>/</span><span class=mi>0</span><span class=p>]).</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>connect</span><span class=p>()</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nn>application</span><span class=p>:</span><span class=nf>start</span><span class=p>(</span><span class=n>asn1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nn>application</span><span class=p>:</span><span class=nf>start</span><span class=p>(</span><span class=n>crypto</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nn>application</span><span class=p>:</span><span class=nf>start</span><span class=p>(</span><span class=n>public_key</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nn>application</span><span class=p>:</span><span class=nf>start</span><span class=p>(</span><span class=n>ssl</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nv>Address</span> <span class=o>=</span> <span class=s>&#34;gateway.sandbox.push.apple.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>Port</span> <span class=o>=</span> <span class=mi>2195</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>Cert</span> <span class=o>=</span> <span class=s>&#34;cert.pem&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>Options</span> <span class=o>=</span> <span class=p>[{</span><span class=n>certfile</span><span class=p>,</span> <span class=nv>Cert</span><span class=p>},</span> <span class=p>{</span><span class=n>mode</span><span class=p>,</span> <span class=n>binary</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>    <span class=nv>Timeout</span> <span class=o>=</span> <span class=mi>10000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nn>ssl</span><span class=p>:</span><span class=nf>connect</span><span class=p>(</span><span class=nv>Address</span><span class=p>,</span> <span class=nv>Port</span><span class=p>,</span> <span class=nv>Options</span><span class=p>,</span> <span class=nv>Timeout</span><span class=p>)</span> <span class=k>of</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=n>ok</span><span class=p>,</span> <span class=nv>Socket</span><span class=p>}</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>PayloadString</span> <span class=o>=</span> <span class=s>&#34;{</span><span class=se>\&#34;</span><span class=s>aps</span><span class=se>\&#34;</span><span class=s>:{</span><span class=se>\&#34;</span><span class=s>alert</span><span class=se>\&#34;</span><span class=s>:</span><span class=se>\&#34;</span><span class=s>Hello world.</span><span class=se>\&#34;</span><span class=s>,</span><span class=se>\&#34;</span><span class=s>sound</span><span class=se>\&#34;</span><span class=s>:</span><span class=se>\&#34;</span><span class=s>chime</span><span class=se>\&#34;</span><span class=s>, </span><span class=se>\&#34;</span><span class=s>badge</span><span class=se>\&#34;</span><span class=s>:1}}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nv>Payload</span> <span class=o>=</span> <span class=nb>list_to_binary</span><span class=p>(</span><span class=nv>PayloadString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nv>PayloadLength</span> <span class=o>=</span> <span class=nb>size</span><span class=p>(</span><span class=nv>Payload</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nv>Packet</span> <span class=o>=</span> <span class=o>&lt;&lt;</span><span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=mi>32</span><span class=p>:</span><span class=mi>16</span><span class=o>/</span><span class=n>big</span><span class=p>,</span>                <span class=mi>16#ff496f96352abb7c875bedfc755287XXXXXXe14bfadade9ff6ba75360de65441</span><span class=p>:</span><span class=mi>256</span><span class=o>/</span><span class=n>big</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nv>PayloadLength</span><span class=p>:</span><span class=mi>16</span><span class=o>/</span><span class=n>big</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nv>Payload</span><span class=o>/</span><span class=n>binary</span><span class=o>&gt;&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nn>ssl</span><span class=p>:</span><span class=nb>send</span><span class=p>(</span><span class=nv>Socket</span><span class=p>,</span> <span class=nv>Packet</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nn>ssl</span><span class=p>:</span><span class=nf>close</span><span class=p>(</span><span class=nv>Socket</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nv>PayloadString</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=n>error</span><span class=p>,</span> <span class=nv>Reason</span><span class=p>}</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>Reason</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span><span class=p>.</span>
</span></span></code></pre></div></li><li><p>有一些开源的 Erlang APNs 推送服务实现，比如 <a href=https://github.com/inaka/apns4erl>apns4erl</a>，不过这个项目实在引用了太多不必要的东西了 XD，还是推荐自己看懂后根据需求重新实现，代码也不复杂</p></li></ul></div><div class=tags><ul class=info><li>2015-01-01</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li><li><a href=https://blog.caoyue.me/tags/ejabberd>#ejabberd</a></li><li><a href=https://blog.caoyue.me/tags/apple>#apple</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2023 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch{}</script></div></footer></div></body></html>