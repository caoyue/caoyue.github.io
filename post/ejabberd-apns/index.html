<html lang="zh"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="default"/><meta name="format-detection" content="telephone=no"/><meta name="theme-color" content="#a6d6d6"/><meta name="msapplication-TileColor" content="#a6d6d6"/><meta name="msapplication-TileImage" content="/icon/favicon.ico"/><meta name="referrer" content="no-referrer"/><title>且听疯吟 / ejabberd: Apple Push Notification Service</title><link rel="alternate" type="application/rss+xml" title="atom 1.0" href="/atom.xml"/><link rel="apple-touch-icon" sizes="192x192" href="/icon/favicon.ico"/><link rel="icon" type="image/png" sizes="48x48" href="/icon/favicon.ico"/><link rel="icon" type="image/png" sizes="192x192" href="/icon/favicon.ico"/><link rel="stylesheet" href="/css/normalize.css"/><link rel="stylesheet" href="/css/style.css"/><meta name="generator" content="Hexo 6.0.0"></head><body><div class="wrap"><div class="header"><a href="/" title="this is a link">且听疯吟</a><span>如此生活三十年</span></div><div class="left"><ul class="list"><li><a href="/" title="Home">Home</a></li><li><a href="/archives" title="archive">Archive</a></li><li><a href="/tags" title="Tags">Tags</a></li></ul></div><div class="right"><div class="entry" id="content"><div class="title">ejabberd: Apple Push Notification Service</div><div class="content"><p>主要是通过 hook ejabberd 的离线消息处理，从而实现针对离线消息进行推送</p>
<h4 id="1-Hook-offline-message"><a href="#1-Hook-offline-message" class="headerlink" title="1. Hook offline message"></a>1. Hook offline message</h4><ul>
<li><p>记录 device token<br>这一步没啥好说的，iOS 连接到 APNs 后获取到 device token，发给服务器，服务器负责维护好对应关系即可。<br>注意客户端退出时清理掉相应记录。</p>
</li>
<li><p>在 ejabberd 中新增一个模块，注册 <code>offline_message_hook</code>，大致如下：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">start</span><span class="params">(Host, Opts)</span> -&gt;</span></span><br><span class="line">?INFO_MSG(<span class="string">&quot;Starting mod_push_service&quot;</span>, []),</span><br><span class="line">register(?MODULE, spawn(?MODULE, init, [Host, Opts])),</span><br><span class="line">ok.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">(Host, _Opts)</span> -&gt;</span></span><br><span class="line">    ejabberd_hooks:add(offline_message_hook, Host, ?MODULE, send_notification, <span class="number">10</span>),</span><br><span class="line">    ok.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span><span class="params">(Host)</span> -&gt;</span></span><br><span class="line">    ?INFO_MSG(<span class="string">&quot;Stopping mod_push_service&quot;</span>, []),</span><br><span class="line">    ejabberd_hooks:delete(offline_message_hook, Host,</span><br><span class="line">        ?MODULE, send_notification, <span class="number">10</span>),</span><br><span class="line">    ok.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">send_notification</span><span class="params">(From, To, Packet)</span> -&gt;</span></span><br><span class="line">    dosomething.</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-Implement-APNs"><a href="#2-Implement-APNs" class="headerlink" title="2. Implement APNs"></a>2. Implement APNs</h4><ul>
<li><p>从 Apple 获取推送证书</p>
</li>
<li><p>在服务端使用该证书建立 ssl 连接</p>
</li>
<li><p>按照 Apple 文档生成指定格式的 Payload 并发送</p>
</li>
<li><p>Apple 同时提供了 feedback channel 来获取失效 token 便于服务端获取记录，实现方式和发送消息类似，区别在于一个是发送消息，一个是接收消息</p>
</li>
<li><p>连接的粗略代码如下</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(apntest)</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([connect/<span class="number">0</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">connect</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    application:start(asn1),</span><br><span class="line">    application:start(crypto),</span><br><span class="line">    application:start(public_key),</span><br><span class="line">    application:start(ssl),</span><br><span class="line">    Address = <span class="string">&quot;gateway.sandbox.push.apple.com&quot;</span>,</span><br><span class="line">    Port = <span class="number">2195</span>,</span><br><span class="line">    Cert = <span class="string">&quot;cert.pem&quot;</span>,</span><br><span class="line">    Options = [&#123;certfile, Cert&#125;, &#123;mode, binary&#125;],</span><br><span class="line">    Timeout = <span class="number">10000</span>,</span><br><span class="line">    <span class="keyword">case</span> ssl:connect(Address, Port, Options, Timeout) <span class="keyword">of</span></span><br><span class="line">        &#123;ok, Socket&#125; -&gt;</span><br><span class="line">            PayloadString = <span class="string">&quot;&#123;\&quot;aps\&quot;:&#123;\&quot;alert\&quot;:\&quot;Hello world.\&quot;,\&quot;sound\&quot;:\&quot;chime\&quot;, \&quot;badge\&quot;:1&#125;&#125;&quot;</span>,</span><br><span class="line">            Payload = list_to_binary(PayloadString),</span><br><span class="line">            PayloadLength = size(Payload),</span><br><span class="line">            Packet = &lt;&lt;<span class="number">0</span>:<span class="number">8</span>,</span><br><span class="line">            <span class="number">32</span>:<span class="number">16</span>/big,                <span class="number">16#ff496f96352abb7c875bedfc755287</span>XXXXXXe14bfadade9ff6ba75360de65441:<span class="number">256</span>/big,</span><br><span class="line">            PayloadLength:<span class="number">16</span>/big,</span><br><span class="line">            Payload/binary&gt;&gt;,</span><br><span class="line">            ssl:send(Socket, Packet),</span><br><span class="line">            ssl:close(Socket),</span><br><span class="line">            PayloadString;</span><br><span class="line">        &#123;error, Reason&#125; -&gt;</span><br><span class="line">            Reason</span><br><span class="line">    <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>有一些开源的 Erlang APNs 推送服务实现，比如 <a target="_blank" rel="noopener" href="https://github.com/inaka/apns4erl">apns4erl</a>，不过这个项目实在引用了太多不必要的东西了 XD，还是推荐自己看懂后根据需求重新实现，代码也不复杂</p>
</li>
</ul>
</div><div><ul class="info"><li>posted on 2015-01-01<li><a href="/tags/erlang/">#erlang</a></li><li><a href="/tags/ejabberd/">#ejabberd</a></li><li><a href="/tags/apple/">#apple</a></li></li></ul></div></div><div id="disqus_thread"></div><script>var disqus_config = function () {
    this.page.url = "https://blog.caoyue.me/post/ejabberd-apns/";
    this.page.identifier = "post/ejabberd-apns/";
};

(function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://caoyue.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script></div><div class="footer"><div></div>©2021<a href="https://blog.caoyue.me"> 且听疯吟</a>. designed by<a href="https://caoyue.me" target="_blank"> caoyue</a>. powered by<a href="https://hexo.io/" target="_blank"> hexo</a></div><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
</div></body></html>