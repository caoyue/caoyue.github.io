<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="1. 预排序遍历树算法  mptt (Modified Preorder Tree Traversal)1 优点
查询效率高，只需要一次查询即可获得层级结构中某个节点的所有子节点，无需递归查询 缺点
插入、删除、移动节点效率较低 适用
在传统关系数据库中实现层级树结构  读压力 > 写压力， mptt 算法可以提高效率 写压力 > 读压力，使用传统的邻接表 (adjacency list model)    2. 增删查改   Create
 假设增加的节点为 c, 该节点前一节点为 p 节点 c 左值为 p 的右值 +1，右值为 p 右值 +2 所有左值大于节点 c 的左值的节点，其左值均 +2 所有右值大于节点 c 的右值的节点，其右值均 +2 写入节点 c 到数据库  SELECT@cRight:=rgtFROMmpttWHEREname='p';UPDATEmpttSETrgt=rgt+2WHERErgt>@cRight;UPDATEmpttSETlft=lft+2WHERElft>@cRight;INSERTINTOmptt(name,lft,rgt)VALUES('c',@cRight+1,@cRight+2);  Read
  查询节点 c 的子节点：
  查询所有左值大于 c 的左值且右值小于 c 的右值的节点"><meta name=author content="caoyue"><title>且听疯吟 / 预排序遍历算法树</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry id=cotent><div class=title>预排序遍历算法树</div><div class=content><p><img src=http://ww2.sinaimg.cn/large/3e69b0ccgw1et1gl2lw6wj20o20d30ti.jpg alt=mptt></p><h4 id=1-预排序遍历树算法>1. 预排序遍历树算法</h4><ul><li>mptt (Modified Preorder Tree Traversal)<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li><li>优点<br>查询效率高，只需要一次查询即可获得层级结构中某个节点的所有子节点，无需递归查询</li><li>缺点<br>插入、删除、移动节点效率较低</li><li>适用<br>在传统关系数据库中实现层级树结构<ul><li>读压力 > 写压力， mptt 算法可以提高效率</li><li>写压力 > 读压力，使用传统的邻接表 (adjacency list model)</li></ul></li></ul><h4 id=2-增删查改>2. 增删查改</h4><ul><li><p>Create</p><ul><li>假设增加的节点为 <code>c</code>, 该节点前一节点为 <code>p</code></li><li>节点 <code>c</code> 左值为 <code>p</code> 的右值 <code>+1</code>，右值为 <code>p</code> 右值 <code>+2</code></li><li>所有左值大于节点 <code>c</code> 的左值的节点，其左值均 <code>+2</code></li><li>所有右值大于节点 <code>c</code> 的右值的节点，其右值均 <code>+2</code></li><li>写入节点 <code>c</code> 到数据库</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>@</span><span class=n>cRight</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>rgt</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>mptt</span><span class=w>	</span><span class=k>WHERE</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;p&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>mptt</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>rgt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rgt</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>rgt</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>cRight</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>mptt</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>cRight</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>mptt</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>lft</span><span class=p>,</span><span class=w> </span><span class=n>rgt</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=s1>&#39;c&#39;</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>cRight</span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>cRight</span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div></li><li><p>Read</p><ul><li><p>查询节点 <code>c</code> 的子节点：</p><ul><li><p>查询所有左值大于 <code>c</code> 的左值且右值小于 <code>c</code> 的右值的节点</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>mptt</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=o>@</span><span class=n>cLeft</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=o>@</span><span class=n>cRight</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div></li></ul></li><li><p>查询节点 <code>c</code> 的父节点：</p><ul><li><p>查询所有左值小于 <code>c</code> 的左值且右值大于 <code>c</code> 的右值(或左值)的节点</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>mptt</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=o>@</span><span class=n>cLeft</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>rgt</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>cLeft</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div></li></ul></li><li><p>节点 <code>c</code> 的子节点个数：</p><ul><li><code>(c.right - c.left - 1) / 2</code></li></ul></li></ul></li><li><p>Update<br>移动节点即：</p><ul><li>删除节点</li><li>在指定位置新增节点</li></ul></li><li><p>Delete</p><ul><li>删除节点 <code>c</code></li><li>所有右值大于 <code>c</code> 右值的节点，右值 <code>-2</code></li><li>所有左值大于 <code>c</code> 左值的节点，左值 <code>-2</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>mptty</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=o>@</span><span class=n>cLeft</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>@</span><span class=n>cRight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>mptt</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>rgt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rgt</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>rgt</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>cRight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>mptt</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>lft</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>@</span><span class=n>cLeft</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div></li></ul><h4 id=3-重建树结构>3. 重建树结构</h4><p>很容易推断，对排序好的 mptt tree，仅需要一次遍历，即可根据所有节点的左右值记录重建树结构<br>以 python 为例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Node class</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Node</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>left</span><span class=p>,</span> <span class=n>right</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>Node</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>left</span> <span class=o>=</span> <span class=n>left</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>right</span> <span class=o>=</span> <span class=n>right</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>depth</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>children</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=c1># arg: Node List</span>
</span></span><span class=line><span class=cl> <span class=k>def</span> <span class=nf>rebuild</span><span class=p>(</span><span class=n>l</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=c1># 节点按左值排序，即遍历顺序</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>left</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1># 使用列表暂存每层子树的父节点</span>
</span></span><span class=line><span class=cl>        <span class=c1># 如 pi[0] 表示第 2 层的节点的父节点在 l 中的 index</span>
</span></span><span class=line><span class=cl>        <span class=n>pi</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>l</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>left</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=o>=</span> <span class=n>l</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 使用 c 表示此节点，p 表示 c 的前一节点</span>
</span></span><span class=line><span class=cl>                <span class=c1># 如果连续的两个节点 c 和 p 的左值增加幅度为 1，则说明其深度增加了 1</span>
</span></span><span class=line><span class=cl>                <span class=c1># 且 p 为 c 及 c 的兄弟节点的父节点</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>left</span> <span class=o>==</span> <span class=n>p</span><span class=o>.</span><span class=n>left</span> <span class=o>+</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>c</span><span class=o>.</span><span class=n>depth</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>depth</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>depth</span> <span class=o>-</span> <span class=mi>1</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>pi</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>pi</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>pi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>depth</span> <span class=o>-</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 如果 c 的左值大于 p 的父节点的右值，则说明 p 与 c 并非兄弟节点</span>
</span></span><span class=line><span class=cl>                <span class=c1># 并可以计算出两节点的深度差为 c 的左值与 p 的右值之差减 1</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>c</span><span class=o>.</span><span class=n>left</span> <span class=o>&gt;</span> <span class=n>l</span><span class=p>[</span><span class=n>pi</span><span class=p>[</span><span class=n>p</span><span class=o>.</span><span class=n>depth</span> <span class=o>-</span> <span class=mi>2</span><span class=p>]]</span><span class=o>.</span><span class=n>right</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>c</span><span class=o>.</span><span class=n>depth</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>depth</span> <span class=o>-</span> <span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>left</span> <span class=o>-</span> <span class=n>p</span><span class=o>.</span><span class=n>right</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 不满足以上两个条件，说明 c 是 p 的兄弟节点</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>c</span><span class=o>.</span><span class=n>depth</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>depth</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			    <span class=c1># 将 c 作为 pi 中记录的父节点的子节点</span>
</span></span><span class=line><span class=cl>                <span class=n>l</span><span class=p>[</span><span class=n>pi</span><span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>depth</span> <span class=o>-</span> <span class=mi>2</span><span class=p>]]</span><span class=o>.</span><span class=n>children</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>l</span>
</span></span></code></pre></div><hr><h4 id=update>Update</h4><p>完整代码及生成 Json 和基于 D3.js<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> 的树状图：<br><a href=https://gist.github.com/caoyue/704e472215af29b08a27>https://gist.github.com/caoyue/704e472215af29b08a27</a></p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>[1] <a href=http://www.sitepoint.com/hierarchical-data-database-2>http://www.sitepoint.com/hierarchical-data-database-2</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>[2] <a href=http://d3js.org>http://d3js.org</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class=tags><ul class=info><li>2015-05-11</li><li><a href=https://blog.caoyue.me/tags/programming>#programming</a></li><li class=button title="show comments" id=toggle-comments><i class="fa-solid fa-message"></i></li></ul></div></div><div class=comments id=comments><section class="article discussion" style=display:none><script>function loadComment(){let t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","caoyue/caoyue.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("label","Comment"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",''),document.querySelector("section.article.discussion").innerHTML='',document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()});function toggleComment(){let e=document.querySelector("section.article.discussion");e.style.display=="none"?e.style.display="block":e.style.display="none"}document.querySelector("#toggle-comments").addEventListener("click",toggleComment)</script></section></div></div><footer class=footer><div>©2022 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch(e){}</script></div></footer></div></body></html>