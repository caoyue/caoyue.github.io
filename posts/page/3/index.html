<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#a6d6d6"><meta name=referrer content="no-referrer"><meta name=description content="如此生活三十年"><meta name=author content="caoyue"><title>且听疯吟 / Posts</title><link rel=alternate type=application/rss+xml href=/index.xml title=且听疯吟><link rel=apple-touch-icon sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=48x48 href=https://blog.caoyue.me/favicon.png><link rel=icon type=image/png sizes=192x192 href=https://blog.caoyue.me/favicon.png><link rel=stylesheet type=text/css href=https://blog.caoyue.me/normalize.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/scss/style.css><link rel=stylesheet type=text/css href=https://blog.caoyue.me/syntax/monokailight.css id=syntax-theme><script type=text/javascript>function syntaxHighlight(){var e=document.querySelector("#syntax-theme");let t="https://blog.caoyue.me/syntax/monokailight.css",n="https://blog.caoyue.me/syntax/dracula.css",s=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:t;e.href=s}syntaxHighlight(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{syntaxHighlight()})</script><script src=https://kit.fontawesome.com/061cfdc036.js crossorigin=anonymous></script></head><body><div class=wrap><header class=header><a href=/ title=且听疯吟>且听疯吟</a>
<span>如此生活三十年</span></header><div class=left><ul class=list><li><a href=/ title=Home>Home</a></li><li><a href=/tweets title=碎碎念>Tweets</a></li><li><a href=/archives title=Archives>Archives</a></li><li><a href=/tags title=Tags>Tags</a></li></ul></div><div class=right><div class=entry><div class=title><a href=https://blog.caoyue.me/post/erlang-programming-3/>Erlang Programming 笔记 3</a></div><div class=content><h3 id=6-编译并运行程序>6. 编译并运行程序</h3><ul><li>（略）</li></ul><h3 id=7-并发>7. 并发</h3><ul><li>机制<ul><li>Erlang 程序由成百上千个 Process 组成，这些 Process 之间可以互发消息</li><li>Process 能否接收到或者理解消息是不确定的，要知道结果必须向该 Process 发送消息询问并等待</li><li>Process 之间可以互相 Link ，当 Process 消亡时与之相连的 Process 会收到消息</li></ul></li></ul><h3 id=8-并发编程>8. 并发编程</h3><ul><li><p>并发原语</p><ul><li><code>Pid = spawn(Module, FuncName, Args)</code><br>创建一个新的 Process，用于对 Func 求值，并返回该 Process 的 pid</li><li><code>Pid ! Message</code><ul><li>向指定 Pid 的 Process 发送消息，返回值为 Message 本身</li><li>消息发送是异步的，无需等待即可进行其他操作</li></ul></li><li><code>receive ... end</code><ul><li>接收一个发给当前进程的消息</li></ul></li><li><code>self()</code><br>获取自己的 pid</li></ul></li><li><p>注册进程</p><ul><li><code>register(AnAtom, Pid)</code></li><li><code>unregiseter(AnAtom)</code><br>进程死亡时会自动 unregiseter</li></ul></li><li><p>编写并发程序的一般模式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=p>-</span><span class=ni>module</span> <span class=p>(</span><span class=n>concurrency</span><span class=p>).</span>
</span></span><span class=line><span class=cl><span class=p>-</span><span class=ni>compile</span><span class=p>(</span><span class=n>export_all</span><span class=p>).</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>start</span><span class=p>()</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nb>spawn</span><span class=p>(</span><span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=n>loop</span><span class=p>,</span> <span class=p>[]).</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>rpc</span><span class=p>(</span><span class=nv>Pid</span><span class=p>,</span> <span class=nv>Request</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nv>Pid</span> <span class=o>!</span> <span class=p>{</span><span class=n>self</span><span class=p>(),</span> <span class=nv>Request</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=k>receive</span>
</span></span><span class=line><span class=cl>         <span class=p>{</span><span class=nv>Pid</span><span class=p>,</span> <span class=nv>Response</span><span class=p>}</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>             <span class=p>{</span><span class=nv>Pid</span><span class=p>,</span> <span class=nv>Response</span><span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=k>end</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>loop</span><span class=p>(</span><span class=nv>X</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=k>receive</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=nv>From</span><span class=p>,</span> <span class=nv>Any</span><span class=p>}</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>From</span> <span class=o>!</span> <span class=p>{</span><span class=n>self</span><span class=p>(),</span> <span class=s>&#34;Received!&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nn>io</span><span class=p>:</span><span class=nf>format</span><span class=p>(</span><span class=s>&#34;Received: </span><span class=si>~p~n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>[</span><span class=nv>Any</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>            <span class=n>loop</span><span class=p>(</span><span class=nv>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span><span class=p>.</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=c>%% run in erlang shell
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>Pid</span> <span class=o>=</span> <span class=nn>concurrency</span><span class=p>:</span><span class=nf>start</span><span class=p>().</span>
</span></span><span class=line><span class=cl><span class=c>%% &lt;0.33.0&gt;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nn>concurrency</span><span class=p>:</span><span class=nf>rpc</span><span class=p>(</span><span class=nv>Pid</span><span class=p>,</span> <span class=s>&#34;test！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c>%% Received: &#34;test&#34;
</span></span></span><span class=line><span class=cl><span class=c>%% {&lt;0.56.0&gt;,&#34;Received!&#34;}
</span></span></span></code></pre></div></li></ul></div><div class=tags><ul class=info><li>2015-04-23</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/erlang-programming-2/>Erlang Programming 笔记 2</a></div><div class=content><h3 id=4-异常>4. 异常</h3><ul><li><p>抛出异常</p><ul><li>显式的 <code>exit(Why)</code><ul><li>终止当前 Process</li><li>如果当前 Process 未捕获这个异常，则系统会向所有 link 该 Process 的 Process 广播 <code>{'EXIT', Pid, Why}</code> 消息</li></ul></li><li>显式的 <code>throw(Why)</code><ul><li>抛出供其调用者捕获的异常</li><li>最好是添加注释说明抛出的异常</li><li>如何处理由调用者选择，包括忽略</li></ul></li><li>系统错误 <code>erlang:error(Why)</code></li></ul></li><li><p><code>try..catch</code> 捕获异常</p><ul><li><p>try/catch 本身会消耗一点性能</p></li><li><p><a href=http://stackoverflow.com/questions/666111/how-do-i-elegantly-check-many-conditions-in-erlang/669075#669075>推荐的 try/catch 风格</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=c>%% 首先对 FuncOrExpressionSequence 求值
</span></span></span><span class=line><span class=cl><span class=c>%% 如果没有产生异常则顺序进行 Patterm 匹配, 匹配成功后执行后面的表达式
</span></span></span><span class=line><span class=cl><span class=c>%% 如果有异常抛出, 则顺序匹配 ExPattern(ExceptionType 是 throw、exit、error 中的一个, 默认为 throw)
</span></span></span><span class=line><span class=cl><span class=c>%% after 块中的代码用于清理工作,绝对会执行
</span></span></span><span class=line><span class=cl><span class=c>%% after 可以省略
</span></span></span><span class=line><span class=cl><span class=c></span><span class=k>try</span> <span class=nv>FuncOrExpressionSequence</span> <span class=k>of</span>
</span></span><span class=line><span class=cl>    <span class=nv>Pattern1</span> <span class=p>[</span><span class=k>when</span> <span class=nv>Guard1</span><span class=p>]</span> <span class=o>-&gt;</span><span class=nv>Expressions1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>Pattern2</span> <span class=p>[</span><span class=k>when</span> <span class=nv>Guard2</span><span class=p>]</span> <span class=o>-&gt;</span><span class=nv>Expressions2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>catch</span>
</span></span><span class=line><span class=cl>    <span class=nv>ExceptionType</span><span class=p>:</span> <span class=nv>ExPattern1</span> <span class=p>[</span><span class=k>when</span> <span class=nv>ExGuard1</span><span class=p>]</span> <span class=o>-&gt;</span><span class=nv>ExExpressions1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>ExceptionType</span><span class=p>:</span> <span class=nv>ExPattern2</span> <span class=p>[</span><span class=k>when</span> <span class=nv>ExGuard2</span><span class=p>]</span> <span class=o>-&gt;</span><span class=nv>ExExpressions2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>after</span>
</span></span><span class=line><span class=cl>    <span class=nv>AfterExpressions</span>
</span></span><span class=line><span class=cl><span class=k>end</span><span class=p>.</span>
</span></span></code></pre></div></li></ul></li><li><p>栈跟踪</p><ul><li><p>在触发异常的时候可以调用 <code>erlang:get_stacktrace/0</code> 来查看最近的栈跟踪信息，可以获得异常函数的调用路径（尾递归调用除外）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=k>try</span> <span class=n>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>catch</span>
</span></span><span class=line><span class=cl>	<span class=nn>error</span><span class=p>:</span> <span class=nv>X</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=nv>X</span><span class=p>,</span> <span class=nn>erlang</span><span class=p>:</span><span class=nf>get_stacktrace</span><span class=p>()}</span>
</span></span><span class=line><span class=cl><span class=k>end</span><span class=p>.</span>
</span></span></code></pre></div></li></ul></li></ul><h3 id=5-顺序型编程进阶>5. 顺序型编程进阶</h3><ul><li><p>BIF (built-in function)</p><ul><li><p>binary</p><ul><li><p>相对于 List 活着 tuple , binary 更节省内存，输入输出更为高效</p></li><li><p><code>binary_to_term/term_to_binary</code> 可将任何的 binary 和 Erlang 值（List、atom、tuple 甚至 binary 等）转换成为 binary，但是这个 binary 是以所谓的 「外部数据格式」 存储的，类似于其他语言的序列化与反序列化）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nv>A</span> <span class=o>=</span> <span class=o>&lt;&lt;</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=o>&gt;&gt;</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=nv>B</span> <span class=o>=</span> <span class=nb>term_to_binary</span><span class=p>(</span><span class=nv>A</span><span class=p>).</span>
</span></span><span class=line><span class=cl><span class=c>%% &lt;&lt;131,109,0,0,0,3,1,2,3&gt;&gt;
</span></span></span></code></pre></div></li><li><p>binary 中的数字，每一个都在 0~255 之间（因为每一个数字表示一个 byte，其值在 0000 0000 ~ 1111 1111 [0 ~ 2<sup>9</sup> -1] 之间）</p></li><li><p>GB2312 的汉字转成 UTF-8 时，绝大多数是 3 个字节</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nv>A</span> <span class=o>=</span> <span class=o>&lt;&lt;</span><span class=s>&#34;且听疯吟&#34;</span><span class=o>/</span><span class=n>utf8</span><span class=o>&gt;&gt;</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=c>%% &lt;&lt;228,184,148,229,144,172,231,150,175,229,144,159&gt;&gt;
</span></span></span></code></pre></div></li></ul></li><li><p>bit 语法</p><ul><li><p>封包与解包</p><ul><li><p>以 RGB 色彩为例：<br>创建一个 16 bit (2 byte)的内存块，存放一个 RGB 三元组，并为 Red 分配 5 bit，为 Green 分配 6 bit，为 Blue 分配 5 bit</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nv>Red</span> <span class=o>=</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nv>Green</span> <span class=o>=</span> <span class=mi>60</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nv>Blue</span> <span class=o>=</span> <span class=mi>29</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nv>RGB</span> <span class=o>=</span> <span class=o>&lt;&lt;</span><span class=nv>Red</span><span class=p>:</span><span class=mi>5</span><span class=p>,</span> <span class=nv>Green</span><span class=p>:</span><span class=mi>6</span><span class=p>,</span> <span class=nv>Blue</span><span class=p>:</span><span class=mi>5</span><span class=o>&gt;&gt;</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=c>%% &lt;&lt;23, 157&gt;&gt;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=o>&lt;&lt;</span><span class=nv>R1</span><span class=p>:</span><span class=mi>5</span><span class=p>,</span> <span class=nv>G1</span><span class=p>:</span><span class=mi>6</span><span class=p>,</span> <span class=nv>B1</span><span class=p>:</span><span class=mi>5</span><span class=o>&gt;&gt;</span> <span class=o>=</span> <span class=nv>RGB</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nv>R1</span><span class=p>,</span> <span class=nv>G1</span><span class=p>,</span> <span class=nv>B1</span><span class=p>}.</span>
</span></span><span class=line><span class=cl><span class=c>%% {2, 60, 29}
</span></span></span></code></pre></div></li><li><p>注意取值范围。比如我们为 Blue 分配了 5 bit，但是为 Blue 赋值 61，转换成二进制为 111101，超过了 5 bit，则会发生截断，取低五位，即实际值为 29</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nb>integer_to_list</span><span class=p>(</span><span class=mi>61</span><span class=p>,</span><span class=mi>2</span><span class=p>).</span>
</span></span><span class=line><span class=cl><span class=c>%% &#34;111101&#34;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>integer_to_list</span><span class=p>(</span><span class=mi>29</span><span class=p>,</span><span class=mi>2</span><span class=p>).</span>
</span></span><span class=line><span class=cl><span class=c>%% &#34;11101&#34;
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=o>&lt;&lt;</span><span class=mi>2</span><span class=p>:</span><span class=mi>5</span><span class=p>,</span><span class=mi>60</span><span class=p>:</span><span class=mi>6</span><span class=p>,</span><span class=mi>61</span><span class=p>:</span><span class=mi>5</span><span class=o>&gt;&gt;</span> <span class=o>==</span> <span class=o>&lt;&lt;</span><span class=mi>2</span><span class=p>:</span><span class=mi>5</span><span class=p>,</span><span class=mi>60</span><span class=p>:</span><span class=mi>6</span><span class=p>,</span><span class=mi>29</span><span class=p>:</span><span class=mi>5</span><span class=o>&gt;&gt;</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=c>%% true
</span></span></span></code></pre></div></li></ul></li></ul><ul><li>bit 语法表达式<ul><li>形如 <code>&lt;&lt;E1, E2, E3, ... , En>></code></li><li>每一个元素都是二进制数据中的一个区块</li><li>元素的值表示有下面几种方式<ul><li><code>Value</code></li><li><code>Value:Size</code></li><li><code>Value/TypeSpecifierList</code></li><li><code>Value:Size/TypeSpecifierList</code></li></ul></li><li>其中 <code>TypeSpecifierList</code> 是形如 <code>End-Sign-Type-Unit</code> 组成的字符串，其中不同的 Type 选项如下，每一个都可以忽略且没有顺序要求：<ul><li><code>End = big / native / little</code><br>决定字节序，默认 big</li><li><code>Sign = signerd / unsigned</code><br>仅用于模式匹配，默认 unsigned</li><li><code>Type = integer/ float / binary</code><br>默认 integer</li><li><code>Unit = 1 / 2 / 3 / ... / 255</code><ul><li>整个区块长度为 Size * Unit，其值必须大于或等于 0 且是 8 的倍数</li><li>其值依赖于 Type，如果 Type 是 integer 或者 float，则值为 1 ，是 binary 则值为 8</li></ul></li></ul></li></ul></li><li>binary 模式匹配</li></ul></li><li><p>apply</p><ul><li><code>apply(Module, Func, [Arg1, Arg2, ... , Argn])</code></li><li>对于参数个数已知的函数，<code>M:Func([Arg1, Arg2, ... , Argn])</code> 的调用优于 apply</li><li>使用 apply 调用的函数编译器无法优化，同时许多分析工具也无法分析其细节</li><li>如无必要尽量少用 apply</li></ul></li><li><p>属性</p><ul><li>module</li><li>import</li><li>export</li><li>compile<ul><li>编译器选项，常用的 <code>-compile(export_all).</code></li></ul></li><li>vsn<br>无语法意义，用于文档分析</li><li>用户定义属性 <code>-SomeTag(Value)</code><ul><li>该值会被编译进模块</li><li>该值可以在运行时使用 <code>attrs:module_info()</code> 提取</li><li><code>beam_lib</code> 提供了一系列不加载模块代码就能分析的函数</li></ul></li></ul></li><li><p>块表达式<br>把多个表达式组织为单个表达式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=k>begin</span>
</span></span><span class=line><span class=cl>	<span class=nv>Expression1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nv>Expression2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl>	<span class=nv>ExpressionN</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div></li><li><p>布尔</p><ul><li>Erlang 中不存在布尔类型，通常使用原子 <code>true/false</code> 代替作为布尔符号使用</li><li>布尔表达式：<code>and / not / or / xor</code></li></ul></li><li><p>字符集</p><ul><li>Erlang 默认编码为 <code>ISO-8859-1 (Latin-1)</code></li><li>Erlang 内部没有字符串数据类型，而是用一串整数列表表示</li><li>因此要注意 Unicode 字符的处理</li><li>使用 unicode 模块中如 <code>unicode:characters_to_list</code> 的函数处理 unicode 字符</li></ul></li><li><p>epp</p><ul><li>Erlang 预处理器，扩展宏，插入必须的包含文件等</li></ul></li><li><p>转义字符</p></li><li><p>表达式/表达式序列</p><ul><li>表达式序列的值为序列中最后一个表达式的值</li></ul></li><li><p>函数引用</p></li><li><p>包含文件</p><ul><li><code>include</code></li><li><code>include_lib</code></li></ul></li><li><p>列表操作符</p><ul><li><code>++</code><ul><li>列表添加 <code>ListA ++ ListB</code><br>即把 ListB 附加到 ListA 尾部</li><li>模式匹配中的 <code>++</code><br><code>f("begin" ++ T) -> ...</code> 即相当于模式匹配 <code>[$b, $e, $g, $i, $n | T]</code></li></ul></li><li><code>--</code><br>列表删除 <code>ListA -- ListN</code> ，即从 ListA 中删除 ListB 中的所有元素，若元素 E 在 B 中重复出现 k 次，则只会从 ListA 中按顺序删除 k 个 E</li></ul></li><li><p>宏</p><ul><li>定义<ul><li>不带参数 <code>-define(Macro, ...)</code></li><li>带参数 <code>-define(Macro(X,Y), ...)</code></li><li>预定义宏<ul><li><code>?FILE</code> 当前文件名</li><li><code>?MODULE</code> 当前模块名</li><li><code>?LINE</code> 当前行号</li></ul></li></ul></li><li>宏的流程控制<ul><li><code>-undef(Macro)</code> 取消宏定义，在此语句后无法使用该宏</li><li><code>ifdef / ifndef / else / end</code></li><li>结合调试标志，扩展 debug 日志输出等</li></ul></li></ul></li><li><p>数值类型</p><ul><li>整型<ul><li>整型的计算是精确的</li><li>其计算结果代表的数据长度只受限于可用内存</li><li>表示法<ul><li>传统表示法，<code>1, 1989, -1337</code></li><li>K 进制整数，<code>2#01001011，16#fe34</code></li></ul></li></ul></li><li>浮点型<ul><li>内部以 IEEE 754 的 64 bit 格式表示</li></ul></li></ul></li><li><p>操作符优先级</p></li><li><p>进程字典</p><ul><li><p>每一个 Erlang Process 都有自己的进程字典</p></li><li><p>实际上提供的功能类似于全局变量</p></li><li><p>由于不是非破坏性赋值，会导致代码有副作用</p></li><li><p>尽量少用</p></li><li><p>添加/获取进程字典</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=p>@</span><span class=n>spec</span> <span class=nb>put</span><span class=p>(</span><span class=nv>Key</span><span class=p>,</span> <span class=nv>Value</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nv>OldValue</span> <span class=p>|</span> <span class=n>undefined</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>@</span><span class=n>spec</span> <span class=nb>get</span><span class=p>(</span><span class=nv>Key</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nv>Value</span> <span class=p>|</span> <span class=n>undefined</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>@</span><span class=n>spec</span> <span class=nb>get</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=p>[{</span><span class=nv>Key</span><span class=p>,</span> <span class=nv>Value</span><span class=p>}].</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div></li></ul></li><li><p>引用<br>使用 BIF <code>erlang:make_ref()</code> 创建引用</p></li></ul></li></ul></div><div class=tags><ul class=info><li>2015-04-22</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/erlang-programming-1/>Erlang Programming 笔记 1</a></div><div class=content><h3 id=1-erlang-优势>1. Erlang 优势</h3><ol><li>并发和分布式<ul><li>主流语言使用共享内存模型，类似于 <code>x = x + n</code> 的代码导致了在多核环境下需要小心的处理锁的问题</li><li>Erlang 使用消息模型，Process 间不共享数据，从而避免了锁的问题</li><li>无锁避免了顺序瓶颈，添加节点到网络更容易</li></ul></li><li>错误处理<ul><li>多数语言默认认为程序不会出错</li><li>Erlang 采用不同的设计决策——注定要出错，那就让他出错，出错后恢复就行了。即 Erlang 程序出错后，会交由更高级的 Process 来处理（重启 Child Process、系列全部终止、重启相关 Process 等等），从而实现对错误的分级和容错处理</li><li>同时带来了热更新的好处，进一步保证了可用性</li></ul></li></ol><h3 id=2-入门>2. 入门</h3><ul><li><p>Shell</p><ul><li><code>f().</code> 会释放所有绑定的变量</li><li>崩溃文件分析<br><code>webtool:start().</code></li></ul></li><li><p>原子</p><ul><li><p>使用单引号括起来的字符也是原子</p></li><li><p>这使得原子可以以大写字母开头，或者带有空格</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=n>&#39;a&#39;</span> <span class=o>=</span> <span class=n>a</span><span class=p>.</span>  <span class=c>%a
</span></span></span><span class=line><span class=cl><span class=c></span><span class=n>&#39;Monday&#39;</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=n>&#39;an atom with spaces&#39;</span><span class=p>.</span>
</span></span></code></pre></div></li></ul></li><li><p>列表</p><ul><li><p>可以包含不同类型</p></li><li><p>访问列表的头是高效的，所以通常函数处理也从列表头取起</p></li><li><p>插入元素到列表头部是高效的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nv>A</span> <span class=o>=</span> <span class=p>[</span><span class=s>&#34;a&#34;</span><span class=p>,</span><span class=s>&#34;b&#34;</span><span class=p>].</span>
</span></span><span class=line><span class=cl><span class=nv>C</span> <span class=o>=</span> <span class=p>[</span><span class=s>&#34;c&#34;</span><span class=p>,</span><span class=s>&#34;d&#34;</span> <span class=p>|</span> <span class=nv>A</span> <span class=p>].</span> <span class=c>% [&#34;c&#34;,&#34;d&#34;,&#34;a&#34;,&#34;b&#34;]
</span></span></span></code></pre></div><ul><li>尽量避免使用 <code>List ++ [H]</code> 这样的操作，通常情况下添加元素到列表尾部是极为低效的（重新生成新的列表），只有在列表非常短的时候可以这样用</li><li>添加在头部然后使用 <code>lists:reverse/1</code> 反转通常比添加在列表尾部效率要高</li><li>尽量使用经过高度优化的 BIF ，比如反转列表 <code>lists:reverse/1</code>，可以从源码中找到它的定义，但是这个定义通常是作为简单的声明，实际上编译器会使用这个函数在系统内部更为高效的版本</li></ul></li></ul></li><li><p>字符串</p><ul><li><p>严格说来 Erlang 中并没有字符串</p></li><li><p>字符串实际上是整数列表的一种「速记/代表」形式</p></li><li><p>可用 <code>$</code> 来表示字符串的整数值</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nv>A</span> <span class=o>=</span> <span class=sc>$a</span><span class=p>.</span>  <span class=c>% 97
</span></span></span></code></pre></div></li></ul></li></ul><h3 id=3-顺序型编程>3. 顺序型编程</h3><ul><li><p>beam<br>beam 是 Bogdan&rsquo;s Erlang Abstract Machine 的缩写</p></li><li><p>匿名函数 fun</p><ul><li><p>fun 也可以拥有多个子句</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nv>TempFun</span> <span class=o>=</span> <span class=k>fun</span> <span class=p>({</span><span class=n>square</span><span class=p>,</span> <span class=nv>X</span><span class=p>})</span> <span class=o>-&gt;</span> <span class=nv>X</span><span class=o>*</span><span class=nv>X</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	          <span class=p>({</span><span class=n>double</span><span class=p>,</span><span class=nv>X</span><span class=p>})</span> <span class=o>-&gt;</span> <span class=nv>X</span><span class=o>+</span><span class=nv>X</span>
</span></span><span class=line><span class=cl>  	  <span class=k>end</span><span class=p>.</span>
</span></span></code></pre></div></li></ul></li><li><p>列表解析</p><ul><li><p>列表解析实现最简单的 Map</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>map</span><span class=p>(</span><span class=nv>F</span><span class=p>,</span> <span class=nv>L</span><span class=p>)</span> <span class=o>=</span> <span class=p>[</span><span class=nv>F</span><span class=p>(</span><span class=nv>X</span><span class=p>)</span> <span class=p>||</span> <span class=nv>X</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>].</span>
</span></span></code></pre></div></li><li><p>列表解析中的生成器实际上也可以起到过滤的作用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=p>[</span> <span class=nv>X</span> <span class=p>||</span> <span class=p>{</span><span class=nv>X</span><span class=p>,</span> <span class=p>_}</span> <span class=o>&lt;-</span> <span class=p>[</span> <span class=n>a</span><span class=p>,{</span><span class=n>c</span><span class=p>,</span> <span class=n>d</span><span class=p>},</span> <span class=s>&#34;aa&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s>&#34;c&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>}]].</span>
</span></span><span class=line><span class=cl><span class=c>% [ c, &#34;c&#34;]
</span></span></span></code></pre></div></li><li><p>快排算法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>qsort</span><span class=p>([])</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=nf>qsort</span><span class=p>([</span><span class=nv>Pivot</span> <span class=p>|</span> <span class=nv>T</span><span class=p>])</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>			<span class=n>qsort</span><span class=p>([</span><span class=nv>X</span> <span class=p>||</span> <span class=nv>X</span> <span class=o>&lt;-</span> <span class=nv>T</span><span class=p>,</span> <span class=nv>X</span> <span class=o>&lt;</span> <span class=nv>Pivot</span><span class=p>])</span>
</span></span><span class=line><span class=cl>			<span class=o>++</span> <span class=p>[</span><span class=nv>H</span><span class=p>]</span> <span class=o>++</span>
</span></span><span class=line><span class=cl>			<span class=n>qsort</span><span class=p>([</span><span class=nv>X</span> <span class=p>||</span> <span class=nv>X</span> <span class=o>&lt;-</span> <span class=nv>T</span><span class=p>,</span> <span class=nv>X</span> <span class=o>&gt;=</span> <span class=nv>Pivot</span><span class=p>]).</span>
</span></span></code></pre></div></li><li><p>毕达哥拉斯三元组</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>pythag</span><span class=p>(</span><span class=nv>N</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>[{</span><span class=nv>A</span><span class=p>,</span> <span class=nv>B</span><span class=p>,</span> <span class=nv>C</span><span class=p>}</span> <span class=p>||</span> <span class=nv>A</span> <span class=o>&lt;-</span> <span class=nn>lists</span><span class=p>:</span><span class=nf>seq</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>N</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			  <span class=nv>B</span> <span class=o>&lt;-</span> <span class=nn>lists</span><span class=p>:</span><span class=nf>seq</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>N</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			  <span class=nv>C</span> <span class=o>&lt;-</span> <span class=nn>lists</span><span class=p>:</span><span class=nf>seq</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>N</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			  <span class=nv>A</span> <span class=o>+</span> <span class=nv>B</span> <span class=o>+</span> <span class=nv>C</span> <span class=o>=&lt;</span> <span class=nv>N</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			  <span class=nv>A</span><span class=o>*</span><span class=nv>A</span> <span class=o>+</span> <span class=nv>B</span><span class=o>*</span><span class=nv>B</span> <span class=o>=:=</span> <span class=nv>C</span><span class=o>*</span><span class=nv>C</span>
</span></span><span class=line><span class=cl>	<span class=p>].</span>
</span></span></code></pre></div></li><li><p>全排列</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>perms</span><span class=p>([])</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>[[]];</span>
</span></span><span class=line><span class=cl><span class=nf>perms</span><span class=p>(</span><span class=nv>List</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>[</span> <span class=p>[</span><span class=nv>H</span> <span class=p>|</span> <span class=nv>T</span><span class=p>]</span> <span class=p>||</span> <span class=nv>H</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>,</span> <span class=nv>T</span> <span class=o>&lt;-</span> <span class=n>perms</span><span class=p>(</span><span class=nv>L</span> <span class=o>--</span> <span class=p>[</span><span class=nv>H</span><span class=p>])</span> <span class=p>].</span>
</span></span></code></pre></div></li></ul></li><li><p>断言</p><ul><li><p>以 when 开头</p></li><li><p>用 <code>;</code> 隔开的断言，只要有一个为 <code>true</code> 则断言序列成立</p></li><li><p>用 <code>,</code> 隔开的断言，只有全部为 <code>true</code> 断言才会成立</p></li><li><p>合法的断言必须保证没有副作用，可以包含一些无副作用的 BIF ，但无法使用用户自定义的布尔表达式函数</p></li><li><p><code>and, or</code> 和 <code>andalso, orelse</code><br><a href=http://blog.caoyue.me/post/erlang-guard-and-andalso-or-orelse>Erlang Guard: and/andalso, or/orelse</a></p></li><li><p><code>==</code> 和 <code>=:=</code>，<code>/=</code> 和 <code>=/=</code></p><ul><li><p><code>=:=</code> 代表精确等于，在比较的时候不会对数据类型进行转换</p></li><li><p><code>=/=</code> 代表精确不等于</p></li><li><p>99% 的情况下应使用 <code>=:=</code> 或 <code>=/=</code></p></li><li><p>模式匹配中实际上是 <code>=:=</code>，即 <code>f(12)</code> 不会匹配到 <code>f(12.0)</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=mi>1</span> <span class=o>==</span> <span class=mi>1</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span> <span class=c>% true
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>1</span> <span class=o>=:=</span> <span class=mi>1</span><span class=p>.</span><span class=mi>0</span><span class=err>。</span> <span class=c>%false
</span></span></span></code></pre></div></li></ul></li><li><p>比较运算符的优先级</p><ul><li><p>不同数据类型也可以比较大小，其优先级是：</p><p><code>number &lt; atom &lt; reference &lt; fun &lt; port &lt; pid &lt; tuple &lt; list &lt; binary</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=o>&lt;&lt;</span><span class=s>&#34;1&#34;</span><span class=o>&gt;&gt;</span> <span class=o>&gt;</span> <span class=p>[</span><span class=s>&#34;2&#34;</span><span class=p>].</span>   <span class=c>% true
</span></span></span><span class=line><span class=cl><span class=c></span><span class=p>[</span><span class=s>&#34;2&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=p>{</span><span class=s>&#34;3&#34;</span><span class=p>}.</span> <span class=c>% true
</span></span></span><span class=line><span class=cl><span class=c></span><span class=p>{</span><span class=s>&#34;3&#34;</span><span class=p>}</span> <span class=o>&gt;</span> <span class=n>&#39;atom&#39;</span><span class=p>.</span> <span class=c>% true
</span></span></span><span class=line><span class=cl><span class=c></span><span class=n>atom</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>.</span> <span class=c>% true
</span></span></span></code></pre></div></li></ul></li></ul></li><li><p>record</p><ul><li>Record 实际上只是 tuple 的「伪装」，其本质上是一个 tuple</li></ul></li><li><p>case/if</p><ul><li>Erlang 中不存在多个 case 匹配一个执行块的语法</li><li>Erlang 中任何表达式都是有值的，包括 case，因此可以有 <code>X = case ... end</code></li><li>Case 最后使用 <code>_</code> , if 最后使用 <code>true</code> 是保证所有分支得到匹配的方法</li></ul></li><li><p>累加器</p><ul><li>存储迭代过程中的临时容器</li></ul></li></ul></div><div class=tags><ul class=info><li>2015-04-21</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/the-eight-myths-of-erlang-performance/>Efficiency Guide：关于 Erlang 效率的 8 个迷思</a></div><div class=content><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Premature optimization is the root of all evil. -- D.E. Knuth
</span></span><span class=line><span class=cl>过早的优化是万恶之源. -- D.E. Knuth
</span></span></code></pre></div><p>渣翻译，且作读书笔记 :)<br>原文：<a href=http://www.erlang.org/doc/efficiency_guide/myths.html>The Eight Myths of Erlang Performance</a></p><hr><h4 id=迷思-1funs-很慢>迷思 1：Funs 很慢</h4><p>funs 曾经是比较慢，不，应该说是特别慢，甚至比那个 <code>apply/3</code> 还慢。因为以前我们都是用一堆的语法糖啦，普通的元组啦,还有 <code>apply/3</code> 啦加上我们的奇技淫巧来实现的。<br>不过这些都是老黄历了，在 R6B 我们给了它专有的数据类型，并且在 R7B 做了更牛逼的优化，现在它的调用消耗已经降低到<br>本地调用和 <code>apply/3</code> 之间了。</p><blockquote><h4 id=不靠谱的-note->不靠谱的 Note :</h4><ol><li>这里的 funs 应该是包含了 anonymous function 和 <code>F = fun FunctionName/Arity; F(Arg1, Arg2, ..., Argn)</code> 这些调用方式，在调用效率上这两种应该是基本等价的</li><li>在 OTP R5 和更早之前的版本中，funs 使用元组来表示，在之后的版本中有了专有的数据结构和优化<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li><li>对于参数个数已知的函数，M:F([Arg1, Arg2, &mldr; , Argn]) 的调用优于 apply</li><li>使用 apply 调用的函数编译器无法优化，同时许多分析工具也无法分析其细节<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li></ol></blockquote><h4 id=迷思-2列表推导很慢>迷思 2：列表推导很慢</h4><p>列表推导曾经是用 funs 来实现的，当然参照第一点，你懂的。<br>现在编译器把列表推导重写成一个普通的递归函数。当然，写成尾递归加反转的方式看起来会更快。真的吗？我们下回分解。</p><h4 id=迷思-3尾递归函数远快于普通递归函数>迷思 3：尾递归函数<strong>远</strong>快于普通递归函数</h4><p>我们都知道普通递归函数会在堆栈上留下一堆可能不再使用的数据，而垃圾回收器没有这么聪明，它会不停的拷贝这些数据。而尾递归中这些数据会很快消亡。</p><p>在 R7B 之前这么说没错。在 R7B 中，编译器会把从来不会被用到的数据引用重写成空列表，这样垃圾回器收器就不需要做无用功了。</p><p>当然即使是在优化过后，尾递归函数还是在大多数时候还是比一个普通递归要快。<br>实际上这跟每次递归调用中消耗的堆栈空间有关。一般来说普通递归每次消耗的堆栈空间比尾递归所分配的堆空间要多。更多的内存消耗意味着更多的垃圾回收，以及更多的堆栈遍历。</p><p>在 R12B 以及后续版本中我们又进行了优化，减少了递归调用需要的堆栈空间，普通递归和一个尾递归需要得内存空间在大部分情况下都差不多了。<code>lists:map/2</code>，<code>lists:filter/2</code>，列表推导，和其他一些普通递归函数占用的内存空间和尾递归实现一样了。</p><p>回到我们的老问题，哪一个更快？</p><p>看情况。在 Solaris/Sparc 上，普通递归看起来稍微快那么一点点，即使对于那些有很多元素的列表。在 x86 架构上，尾递归要比普通递归快近 30%。</p><p>剩下的就是个人口味的选择了。如果需要追求极限的速度，就必须要自己<strong>衡量</strong>了。你再也不能拍着胸脯说尾递归在所有情况下都快于普通递归。</p><p>注意：一个尾递归函数，如果最后的结果不需要 <code>lists:reverse/1</code>，显然比一个递归函数要快，因为尾递归函数不需要构造数据项（例如，对列表求和函数）。</p><h4 id=迷思-4-总是不好的>迷思 4：<code>++</code> 总是不好的</h4><p><code>++</code> 操作符的名声总是很糟糕。其实你们都误解了它。主要是跟下面这种写法有关：</p><ul><li><strong>不要</strong>这样做<div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>naive_reverse</span><span class=p>([</span><span class=nv>H</span><span class=p>|</span><span class=nv>T</span><span class=p>])</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>naive_reverse</span><span class=p>(</span><span class=nv>T</span><span class=p>)</span><span class=o>++</span><span class=p>[</span><span class=nv>H</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nf>naive_reverse</span><span class=p>([])</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>[].</span>
</span></span></code></pre></div>这是效率最低的反转列表的方式。因为 <code>++</code> 操作符原理是拷贝它左边的列表，结果就是一遍又一遍的拷贝&mldr;&mldr;最终导致 n<sup>2</sup> 的复杂度。</li><li>像这样的使用是没问题的<div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>naive_but_ok_reverse</span><span class=p>([</span><span class=nv>H</span><span class=p>|</span><span class=nv>T</span><span class=p>],</span> <span class=nv>Acc</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>naive_but_ok_reverse</span><span class=p>(</span><span class=nv>T</span><span class=p>,</span> <span class=p>[</span><span class=nv>H</span><span class=p>]</span><span class=o>++</span><span class=nv>Acc</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>naive_but_ok_reverse</span><span class=p>([],</span> <span class=nv>Acc</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nv>Acc</span><span class=p>.</span>
</span></span></code></pre></div>每一个列表元素只会被拷贝一次。变化的值 <code>Acc</code> 在 <code>++</code> 操作符的右边，它不会被拷贝。</li><li>有经验的 Erlang 程序员会这么写<div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>vanilla_reverse</span><span class=p>([</span><span class=nv>H</span><span class=p>|</span><span class=nv>T</span><span class=p>],</span> <span class=nv>Acc</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>vanilla_reverse</span><span class=p>(</span><span class=nv>T</span><span class=p>,</span> <span class=p>[</span><span class=nv>H</span><span class=p>|</span><span class=nv>Acc</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nf>vanilla_reverse</span><span class=p>([],</span> <span class=nv>Acc</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nv>Acc</span><span class=p>.</span>
</span></span></code></pre></div>这个会稍微更有效率一点，因为没有构建列表元素，只是直接拷贝它而已。（如果编译器没有自动将 <code>[H] ++ Acc</code> 重写为 <code>[H | Acc]</code>，那这种写法就毫无疑问的胜出了）</li></ul><h4 id=迷思-5字符串很慢>迷思 5：字符串很慢</h4><p>某种程度上来说，操作不当会导致字符串处理起来很慢。<br>在 Erlang 中，需要在字符串的使用方式上多注意。<br>另外如果打算用正则表达式，用 re 模块，不要用废弃的 regexp 模块。</p><blockquote><h4 id=不靠谱的-note--1>不靠谱的 Note :</h4><ol><li>实际上确实是「慢」</li><li>这个「慢」倒并不一定体现在运行效率上，不如说是增加了编码的麻烦。</li><li>由于字符串作为列表处理，但字符串是无法避免大量的拼接、裁剪、反转等操作的，要避免额外的列表拷贝，而且在使用的时候必须很小心。</li></ol></blockquote><h4 id=迷思-6修复一个-dets-文件很慢>迷思 6：修复一个 Dets 文件很慢</h4><p>修复时间和 Dets 文件中的记录（records）数量依然成正比，但是过去修复 Dets 非常非常慢，而现在已经改进了。</p><h4 id=迷思-7beam-是一个基于堆栈的字节码虚拟机因此很慢>迷思 7：BEAM 是一个基于堆栈的字节码虚拟机（因此很慢）</h4><p>实际上 BEAM 是一个 threaded-code 解释器。每条指令直接指向可执行 C 代码，指令调度是非常快的。</p><h4 id=迷思-8用-_-来表示不使用的变量可以让程序更快>迷思 8：用 <code>_</code> 来表示不使用的变量可以让程序更快</h4><p>好吧，在古老的某个时候它是对的。<br>但是从 R6B 版本开始，BEAM 编译器已经足够聪明到发现哪些变量是没有使用的了。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>[1] <a href=http://www.erlang.org/doc/programming_examples/funs.html>http://www.erlang.org/doc/programming_examples/funs.html</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>[2]《Erlang Programming》&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=tags><ul class=info><li>2015-03-18</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li><li><a href=https://blog.caoyue.me/tags/translate>#translate</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/about-erlang/>关于 Erlang 的一些想法</a></div><div class=content><p>断断续续学习和使用 Erlang 几个月了，感觉跟之前看待这门语言有了点变化，还是挺有意思的。<br>作为初学者可能理解不太准确，但有些东西还是可以记录一下。</p><h4 id=关于函数式编程>关于函数式编程</h4><ul><li><p>刚开始从其他语言转移到函数式语言的时候还害怕所谓的思维转换，实际上担心有点多余</p></li><li><p>入门并不难，能理解把循环写成尾递归的过程就基本没什么问题了</p></li><li><p>更少的心智负担，不再需要考虑是传值还是传引用，以及糟糕的副作用</p></li><li><p>在某些问题上更接近思维过程，不需要关心<strong>怎么做</strong>，只需要关心<strong>做什么</strong></p><p>比如 erlang 的 quicksort 可以这么写（注意这并不是高效的写法）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>qsort</span><span class=p>([])</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=nf>qsort</span><span class=p>([</span><span class=nv>Pivot</span> <span class=p>|</span> <span class=nv>T</span><span class=p>])</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>qsort</span><span class=p>([</span><span class=nv>X</span> <span class=p>||</span> <span class=nv>X</span> <span class=o>&lt;-</span> <span class=nv>T</span><span class=p>,</span> <span class=nv>X</span> <span class=o>&lt;</span> <span class=nv>Pivot</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=o>++</span> <span class=p>[</span><span class=nv>H</span><span class=p>]</span> <span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=n>qsort</span><span class=p>([</span><span class=nv>X</span> <span class=p>||</span> <span class=nv>X</span> <span class=o>&lt;-</span> <span class=nv>T</span><span class=p>,</span> <span class=nv>X</span> <span class=o>&gt;=</span> <span class=nv>Pivot</span><span class=p>]).</span>
</span></span></code></pre></div></li></ul><h4 id=关于-erlang>关于 Erlang</h4><ul><li>语法简单<ul><li>没有大量的复杂的概念，不像某些《Thinking in XXXX》，看完巨厚一本书你发现自己还是啥也不懂</li><li>没有大量的奇技淫巧</li><li>大概看了一个多月，就基本可以把 ejabberd 代码从头到尾过一遍了</li><li>多看多用，我自己入门看的 《Erlang Programing》</li></ul></li><li>pattern match<ul><li>用过才知道有多好用</li><li>据说效率极其惊人</li><li>据说 C# 也要加入了</li></ul></li><li>并发<ul><li>process<br><ul><li>需要并发执行一个任务的时候，最容易想到的就是新开一个 process 去处理</li><li>Erlang 的 process 是轻量的，开启和关闭消耗也小，不需要操心各种并发问题</li></ul></li><li>避免锁<ul><li>实际上开始写命令式代码的时候，我倒是不怎么担心死锁，担心的反而是应该在哪里加锁……</li><li>Erlang 的并发模型没有试图去解决锁的问题，而是从根源避免了它，那就是根本不允许全局变量共享（当然你需要共享，可以使用 ETS 或者外部数据库）</li><li>对我而言，这种做法减轻了不少心智负担</li></ul></li></ul></li><li>鼓励崩溃和热更新<ul><li>写代码的时候 Server 不用不停重启刷新的感觉太好</li></ul></li><li>效率<ul><li>入门快<br><br>比如我这种不合格的程序猿看了一点《Erlang Programing》就开始写 ejabberd 的模块了</li><li>很容易用<br><br>比如我这样不合格的程序猿也可以很顺利的手写稳定的服务器了</li></ul></li><li>部分不怎么好的地方<ul><li>字符串的处理<br><ul><li>没有单独的字符串类型，而是用 List，从编码效率到处理效率，都不怎么好看</li><li>正则表达式的转义让人蛋疼无比</li></ul></li><li>unicode 字符<br><br>可能一不小心就容易坑了，当然这点在慢慢改进了</li><li>record<br><br>可能 OTP17 后的 map 会方便点</li><li>工具链<br><br>从 IDE 到 debug profile 到 compile，体验都比较……怎么说呢，原始吧。<br>目前用 Intellij IDEA + Erlang Plugin，还凑合。</li><li>出了问题搜索不到<br><br>嗯，这个时候就会嫌弃 Google 不够智能不能帮你写代码了</li></ul></li></ul></div><div class=tags><ul class=info><li>2015-03-16</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li><li><a href=https://blog.caoyue.me/tags/programming>#programming</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/supervisor-simple-one-for-one/>Erlang/OTP Supervisor : one-for-one and simple-one-for-one</a></div><div class=content><p>Supervisor 的四个 Restart Strategy 中，关于 one for one 和 simple one for one , 虽然很多地方都说 simple one for one 是 one for one 的简化版，但两者之间还是有一些不同。</p><h4 id=1-先来看一个简单的-one-for-one-和-simple-one-for-one-的例子>1. 先来看一个简单的 one for one 和 simple one for one 的例子</h4><ul><li><p>one for one</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>init</span><span class=p>(_</span><span class=nv>Args</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=n>ok</span><span class=p>,</span> <span class=p>{{</span><span class=n>one_for_one</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>60</span><span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>[{</span><span class=n>call</span><span class=p>,</span> <span class=p>{</span><span class=n>call</span><span class=p>,</span> <span class=n>start_link</span><span class=p>,</span> <span class=p>[]},</span>
</span></span><span class=line><span class=cl>            <span class=n>permanent</span><span class=p>,</span> <span class=n>brutal_kill</span><span class=p>,</span> <span class=n>worker</span><span class=p>,</span> <span class=p>[</span><span class=n>call</span><span class=p>]}]}}.</span>
</span></span></code></pre></div><ul><li>simple one for one</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>init</span><span class=p>(_</span><span class=nv>Args</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=n>ok</span><span class=p>,</span> <span class=p>{{</span><span class=n>simple_one_for_one</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>[{</span><span class=n>call</span><span class=p>,</span> <span class=p>{</span><span class=n>call</span><span class=p>,</span> <span class=n>start_link</span><span class=p>,</span> <span class=p>[]},</span>
</span></span><span class=line><span class=cl>            <span class=n>permanent</span><span class=p>,</span> <span class=n>brutal_kill</span><span class=p>,</span> <span class=n>worker</span><span class=p>,</span> <span class=p>[</span><span class=n>call</span><span class=p>]}]}}.</span>
</span></span></code></pre></div><p>初始化方法非常相似</p></li></ul><h4 id=2-启动-supervisor>2. 启动 Supervisor</h4><ul><li>one for one<br>启动时，会同时启动一个子进程</li><li>simple one for one<br>启动时，supervisor 并不会启动任何子进程，所有的子进程都是通过 <code>supervisor:start_child(Sup, List)</code> 来动态添加的</li></ul><h4 id=3-允许的-child-type>3. 允许的 Child Type</h4><ul><li>one for one<br>允许不同的 child type，所以每次添加子进程都需要传递完整的 child spec</li><li>simple one for one<br>只能有一个 child type，不同的 child instance 可以共享同一个 child spec</li></ul><h4 id=4-添加子进程>4. 添加子进程</h4><ul><li><p>one for one<br>添加子进程的时候传递的是子进程规格</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nn>supervisor</span><span class=p>:</span><span class=nf>start_child</span><span class=p>(</span><span class=nv>Sup</span><span class=p>,</span> <span class=nv>ChildSpec</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p>simple one for one<br>添加子进程的时候传递的是任意的值列表，它将会被添加到子进程规格中的参数列表中，即实际上是通过 <code>apply(call, start_link, [] ++ List)</code> 来启动的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nn>supervisor</span><span class=p>:</span><span class=nf>start_child</span><span class=p>(</span><span class=nv>Sup</span><span class=p>,</span> <span class=nv>List</span><span class=p>)</span>
</span></span></code></pre></div></li></ul><p>相同的是，如果 supervisor 挂了，并且被 restart，之前动态添加的子进程将会全部丢失</p><h4 id=5-supervisor-停止>5. Supervisor 停止</h4><ul><li>one for one<br>按照启动 Spec 相反的顺序停止所有子进程，然后停止自身</li><li>simple one for one<br>由于 supervisor 启动的是同一子进程的多个 instance，因此在停止的时候不存在顺序，<br>在定义 Shutdown Strategy 的时候应该注意其 terminate 表现的区别。</li></ul></div><div class=tags><ul class=info><li>2015-01-20</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/ejabberd-apns/>ejabberd: Apple Push Notification Service</a></div><div class=content><p>主要是通过 hook ejabberd 的离线消息处理，从而实现针对离线消息进行推送</p><h4 id=1-hook-offline-message>1. Hook offline message</h4><ul><li><p>记录 device token<br>这一步没啥好说的，iOS 连接到 APNs 后获取到 device token，发给服务器，服务器负责维护好对应关系即可。<br>注意客户端退出时清理掉相应记录。</p></li><li><p>在 ejabberd 中新增一个模块，注册 <code>offline_message_hook</code>，大致如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=nf>start</span><span class=p>(</span><span class=nv>Host</span><span class=p>,</span> <span class=nv>Opts</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl><span class=o>?</span><span class=nv>INFO_MSG</span><span class=p>(</span><span class=s>&#34;Starting mod_push_service&#34;</span><span class=p>,</span> <span class=p>[]),</span>
</span></span><span class=line><span class=cl><span class=nb>register</span><span class=p>(</span><span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=nb>spawn</span><span class=p>(</span><span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=n>init</span><span class=p>,</span> <span class=p>[</span><span class=nv>Host</span><span class=p>,</span> <span class=nv>Opts</span><span class=p>])),</span>
</span></span><span class=line><span class=cl><span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>init</span><span class=p>(</span><span class=nv>Host</span><span class=p>,</span> <span class=p>_</span><span class=nv>Opts</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nn>ejabberd_hooks</span><span class=p>:</span><span class=nf>add</span><span class=p>(</span><span class=n>offline_message_hook</span><span class=p>,</span> <span class=nv>Host</span><span class=p>,</span> <span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=n>send_notification</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>stop</span><span class=p>(</span><span class=nv>Host</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span><span class=nv>INFO_MSG</span><span class=p>(</span><span class=s>&#34;Stopping mod_push_service&#34;</span><span class=p>,</span> <span class=p>[]),</span>
</span></span><span class=line><span class=cl>    <span class=nn>ejabberd_hooks</span><span class=p>:</span><span class=nf>delete</span><span class=p>(</span><span class=n>offline_message_hook</span><span class=p>,</span> <span class=nv>Host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=n>send_notification</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>send_notification</span><span class=p>(</span><span class=nv>From</span><span class=p>,</span> <span class=nv>To</span><span class=p>,</span> <span class=nv>Packet</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>dosomething</span><span class=p>.</span>
</span></span></code></pre></div></li></ul><h4 id=2-implement-apns>2. Implement APNs</h4><ul><li><p>从 Apple 获取推送证书</p></li><li><p>在服务端使用该证书建立 ssl 连接</p></li><li><p>按照 Apple 文档生成指定格式的 Payload 并发送</p></li><li><p>Apple 同时提供了 feedback channel 来获取失效 token 便于服务端获取记录，实现方式和发送消息类似，区别在于一个是发送消息，一个是接收消息</p></li><li><p>连接的粗略代码如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erlang data-lang=erlang><span class=line><span class=cl><span class=p>-</span><span class=ni>module</span><span class=p>(</span><span class=n>apntest</span><span class=p>).</span>
</span></span><span class=line><span class=cl><span class=p>-</span><span class=ni>export</span><span class=p>([</span><span class=n>connect</span><span class=o>/</span><span class=mi>0</span><span class=p>]).</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>connect</span><span class=p>()</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nn>application</span><span class=p>:</span><span class=nf>start</span><span class=p>(</span><span class=n>asn1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nn>application</span><span class=p>:</span><span class=nf>start</span><span class=p>(</span><span class=n>crypto</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nn>application</span><span class=p>:</span><span class=nf>start</span><span class=p>(</span><span class=n>public_key</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nn>application</span><span class=p>:</span><span class=nf>start</span><span class=p>(</span><span class=n>ssl</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nv>Address</span> <span class=o>=</span> <span class=s>&#34;gateway.sandbox.push.apple.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>Port</span> <span class=o>=</span> <span class=mi>2195</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>Cert</span> <span class=o>=</span> <span class=s>&#34;cert.pem&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>Options</span> <span class=o>=</span> <span class=p>[{</span><span class=n>certfile</span><span class=p>,</span> <span class=nv>Cert</span><span class=p>},</span> <span class=p>{</span><span class=n>mode</span><span class=p>,</span> <span class=n>binary</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>    <span class=nv>Timeout</span> <span class=o>=</span> <span class=mi>10000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nn>ssl</span><span class=p>:</span><span class=nf>connect</span><span class=p>(</span><span class=nv>Address</span><span class=p>,</span> <span class=nv>Port</span><span class=p>,</span> <span class=nv>Options</span><span class=p>,</span> <span class=nv>Timeout</span><span class=p>)</span> <span class=k>of</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=n>ok</span><span class=p>,</span> <span class=nv>Socket</span><span class=p>}</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>PayloadString</span> <span class=o>=</span> <span class=s>&#34;{</span><span class=se>\&#34;</span><span class=s>aps</span><span class=se>\&#34;</span><span class=s>:{</span><span class=se>\&#34;</span><span class=s>alert</span><span class=se>\&#34;</span><span class=s>:</span><span class=se>\&#34;</span><span class=s>Hello world.</span><span class=se>\&#34;</span><span class=s>,</span><span class=se>\&#34;</span><span class=s>sound</span><span class=se>\&#34;</span><span class=s>:</span><span class=se>\&#34;</span><span class=s>chime</span><span class=se>\&#34;</span><span class=s>, </span><span class=se>\&#34;</span><span class=s>badge</span><span class=se>\&#34;</span><span class=s>:1}}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nv>Payload</span> <span class=o>=</span> <span class=nb>list_to_binary</span><span class=p>(</span><span class=nv>PayloadString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nv>PayloadLength</span> <span class=o>=</span> <span class=nb>size</span><span class=p>(</span><span class=nv>Payload</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nv>Packet</span> <span class=o>=</span> <span class=o>&lt;&lt;</span><span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=mi>32</span><span class=p>:</span><span class=mi>16</span><span class=o>/</span><span class=n>big</span><span class=p>,</span>                <span class=mi>16#ff496f96352abb7c875bedfc755287XXXXXXe14bfadade9ff6ba75360de65441</span><span class=p>:</span><span class=mi>256</span><span class=o>/</span><span class=n>big</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nv>PayloadLength</span><span class=p>:</span><span class=mi>16</span><span class=o>/</span><span class=n>big</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nv>Payload</span><span class=o>/</span><span class=n>binary</span><span class=o>&gt;&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nn>ssl</span><span class=p>:</span><span class=nb>send</span><span class=p>(</span><span class=nv>Socket</span><span class=p>,</span> <span class=nv>Packet</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nn>ssl</span><span class=p>:</span><span class=nf>close</span><span class=p>(</span><span class=nv>Socket</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nv>PayloadString</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=n>error</span><span class=p>,</span> <span class=nv>Reason</span><span class=p>}</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nv>Reason</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span><span class=p>.</span>
</span></span></code></pre></div></li><li><p>有一些开源的 Erlang APNs 推送服务实现，比如 <a href=https://github.com/inaka/apns4erl>apns4erl</a>，不过这个项目实在引用了太多不必要的东西了 XD，还是推荐自己看懂后根据需求重新实现，代码也不复杂</p></li></ul></div><div class=tags><ul class=info><li>2015-01-01</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li><li><a href=https://blog.caoyue.me/tags/ejabberd>#ejabberd</a></li><li><a href=https://blog.caoyue.me/tags/apple>#apple</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/ejabberd-mam/>ejabberd-MAM</a></div><div class=content><h3 id=mam---message-archive-management>MAM - Message Archive Management</h3><h4 id=1-message-archive>1. Message Archive</h4><ul><li>Archiving<br><br>archived tag<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;message</span> <span class=na>to=</span><span class=s>&#39;juliet@capulet.lit/balcony&#39;</span>
</span></span><span class=line><span class=cl>  <span class=na>from=</span><span class=s>&#39;romeo@montague.lit/orchard&#39;</span>
</span></span><span class=line><span class=cl>  <span class=na>type=</span><span class=s>&#39;chat&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;body&gt;</span>Call me but love, and I&#39;ll be new baptized; Henceforth I never will be Romeo.<span class=nt>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;archived</span> <span class=na>by=</span><span class=s>&#39;juliet@capulet.lit&#39;</span> <span class=na>id=</span><span class=s>&#39;28482-98726-73623&#39;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/message&gt;</span>
</span></span></code></pre></div></li></ul><h4 id=2-querying>2. Querying</h4><ul><li><p>Filtering</p><ul><li>by jid<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>type=</span><span class=s>&#39;get&#39;</span> <span class=na>id=</span><span class=s>&#39;juliet1&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;query</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;with&gt;</span>juliet@capulet.lit<span class=nt>&lt;/with&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/query&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div></li><li>by time<div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>type=</span><span class=s>&#39;get&#39;</span> <span class=na>id=</span><span class=s>&#39;juliet1&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;query</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;start&gt;</span>2010-06-07T00:00:00Z<span class=nt>&lt;/start&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;end&gt;</span>2010-07-07T13:23:54Z<span class=nt>&lt;/end&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/query&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div></li><li>by max number</li><li>by uid of message</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>type=</span><span class=s>&#39;get&#39;</span> <span class=na>id=</span><span class=s>&#39;q29303&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;query</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;start&gt;</span>2010-08-07T00:00:00Z<span class=nt>&lt;/start&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;set</span> <span class=na>xmlns=</span><span class=s>&#39;http://jabber.org/protocol/rsm&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>         <span class=nt>&lt;max&gt;</span>10<span class=nt>&lt;/max&gt;</span>
</span></span><span class=line><span class=cl>         <span class=nt>&lt;after&gt;</span>09af3-cc343-b409f<span class=nt>&lt;/after&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/set&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/query&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;message</span> <span class=na>id=</span><span class=s>&#39;aeb213&#39;</span> <span class=na>to=</span><span class=s>&#39;juliet@capulet.lit/chamber&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;result</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span> <span class=na>queryid=</span><span class=s>&#39;f27&#39;</span> <span class=na>id=</span><span class=s>&#39;28482-98726-73623&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;forwarded</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:forward:0&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;delay</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:delay&#39;</span> <span class=na>stamp=</span><span class=s>&#39;2010-07-10T23:08:25Z&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;message</span> <span class=na>to=</span><span class=s>&#39;juliet@capulet.lit/balcony&#39;</span>
</span></span><span class=line><span class=cl>        <span class=na>from=</span><span class=s>&#39;romeo@montague.lit/orchard&#39;</span>
</span></span><span class=line><span class=cl>        <span class=na>type=</span><span class=s>&#39;chat&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;body&gt;</span>Call me but love, and I&#39;ll be new baptized; Henceforth I never will be Romeo.<span class=nt>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/message&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/forwarded&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/message&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;message</span> <span class=na>id=</span><span class=s>&#39;aeb214&#39;</span> <span class=na>to=</span><span class=s>&#39;juliet@capulet.lit/chamber&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;result</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span> <span class=na>queryid=</span><span class=s>&#39;f27&#39;</span> <span class=na>id=</span><span class=s>&#39;5d398-28273-f7382&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;forwarded</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:forward:0&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;delay</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:delay&#39;</span> <span class=na>stamp=</span><span class=s>&#39;2010-07-10T23:09:32Z&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;message</span> <span class=na>to=</span><span class=s>&#39;romeo@montague.lit/orchard&#39;</span>
</span></span><span class=line><span class=cl>         <span class=na>from=</span><span class=s>&#39;juliet@capulet.lit/balcony&#39;</span>
</span></span><span class=line><span class=cl>         <span class=na>type=</span><span class=s>&#39;chat&#39;</span> <span class=na>id=</span><span class=s>&#39;8a54s&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;body&gt;</span>What man art thou that thus bescreen&#39;d in night so stumblest on my counsel?<span class=nt>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/message&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/forwarded&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/result&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/message&gt;</span>
</span></span></code></pre></div></li></ul><h4 id=3-preferences>3. Preferences</h4><ul><li><p>jid list</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl> <span class=nt>&lt;iq</span> <span class=na>type=</span><span class=s>&#39;set&#39;</span> <span class=na>id=</span><span class=s>&#39;juliet2&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;prefs</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:mam:tmp&#39;</span> <span class=na>default=</span><span class=s>&#39;roster&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;always&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;jid&gt;</span>romeo@montague.lit<span class=nt>&lt;/jid&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/always&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;never&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;jid&gt;</span>montague@montague.lit<span class=nt>&lt;/jid&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;/never&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/prefs&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div><ul><li>option:<ul><li>always - all messages are archived by default.</li><li>never - messages are never archived by default.</li><li>roster - messages are archived only if the contact&rsquo;s bare JID is in the user&rsquo;s roster</li></ul></li><li>rules:<ul><li>outgoing - use &rsquo;to&rsquo; attribute</li><li>incomming - use &lsquo;from&rsquo; attribute</li><li>contains resource - compare</li><li>no resource - any resource</li></ul></li></ul></li><li><p>Ad-Hoc Commands<br><br><a href=http://xmpp.org/extensions/xep-0050.html>http://xmpp.org/extensions/xep-0050.html</a></p></li></ul><h4 id=4-security>4. Security</h4><ul><li>archived tag</li><li>only user authorized have permission</li><li>privacy</li></ul><h4 id=5-mongooseim-config-odbc>5. MongooseIM Config (odbc)</h4><ul><li><code>{mod_mam, []}</code><br>enable mam</li><li><code>{mod_mam_odbc_prefs, [pm]}</code><br>archiving preferences<br>pm : user-to-user messages<br>muc : multiple user</li><li><code>{mod_mam_odbc_user, [pm, muc]}</code><br>converting an archive id to an integer</li><li><code>{mod_mam_odbc_arch, [pm, muc]}</code><br>archiving message</li><li><code>mod_mam_odbc_async_writer</code><br>Asynchronous writer, will insert batches of messages.<br>option <code>no_writer</code> set in <code>mod_mam_odbc_arch</code></li></ul></div><div class=tags><ul class=info><li>2014-12-23</li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li><li><a href=https://blog.caoyue.me/tags/ejabberd>#ejabberd</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/ejabberd-login/>ejabberd Login module</a></div><div class=content><p>懒得贴代码，画个渣图看下好了。<br><img src=http://ww2.sinaimg.cn/large/3e69b0ccgw1ekht46lt4pj20ss0ngq5i.jpg alt="ejabberd login module"></p><p>P.S 从图上可以看出 XMPP 确实是细（fán）致（suǒ）之极了，考虑到在移动设备上的使用，这样的效率肯定是无法接受的。<br>对特定的服务来说，没有必要做如此多的交互步骤，考虑做一些简化。</p><hr><h3 id=update-详细的-login-流程>Update: 详细的 login 流程</h3><p><code>gist d0ec83e9aa3c1899287d</code></p></div><div class=tags><ul class=info><li>2014-09-16</li><li><a href=https://blog.caoyue.me/tags/ejabberd>#ejabberd</a></li><li><a href=https://blog.caoyue.me/tags/erlang>#erlang</a></li></ul></div></div><div class=entry><div class=title><a href=https://blog.caoyue.me/post/xmpp-protocol/>XMPP protocol</a></div><div class=content><h3 id=xmpp-协议>XMPP 协议</h3><p>XMPP 协议是一种基于 XML 的 IM 协议，其前身是 jabber，后来被 IETF 标准化。其他信息可以参考 <a href=http://en.wikipedia.org/wiki/XMPP>wikipedia</a>.</p><h4 id=协议架构>协议架构</h4><ul><li>通过 TCP socket 与 XMPP 服务器进行通信</li><li>传输的是预定格式的 XML 信息</li><li>通过解析 XML 提取请求类型和消息</li></ul><h4 id=消息格式>消息格式</h4><ul><li><p>一个实体在 XMPP 网络中被称为一个节点，它有唯一的标示符 jabber identifier (JID)，实体可以是用户或者聊天室</p></li><li><p>XMPP 中定义了 3 个顶层元素： <code>Message</code>、<code>Presence</code>、<code>IQ</code></p><ul><li><p>Message<br><br>基本的消息通讯格式：<br></p><ul><li>To：消息的接收方</li><li>from : 发送方的 JID</li><li>body: 要发送的消息</li><li>type:<br><ul><li>normal：单纯的消息，不要求响应；</li><li>chat：IM 消息</li><li>groupchat：聊天室 group chat</li><li>headline：发送 alert 和 notification 消息</li><li>error：发送 message 出错时通知</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-XML data-lang=XML><span class=line><span class=cl><span class=nt>&lt;message</span> <span class=na>from=</span><span class=s>&#39;nobody@caoyue.me/test&#39;</span>
</span></span><span class=line><span class=cl> <span class=na>to=</span><span class=s>&#39;anybody@caoyue.me&#39;</span> <span class=na>type=</span><span class=s>&#39;chat&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;body&gt;</span>Anybody?<span class=nt>&lt;/body&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/message&gt;</span>
</span></span></code></pre></div></li><li><p>Presence<br><br>用来表明用户的状态，如：online、away、dnd (请勿打扰)等。<br>当用户离线或改变自己的状态时，就会在 stream 的上下文中插入一个 Presence 元素，来表明自身的状态。要想接受 presence 消息，必须经过一个叫做 presence subscription 的授权过程。</p><ul><li>type: 非必须<br><ul><li>subscribe：订阅其他用户的状态</li><li>probe：请求获取其他用户的状态</li><li>unavailable：不可用，offline</li></ul></li><li>show: 用户当前状态<ul><li>chat：聊天中</li><li>away：暂离</li><li>xa：eXtend Away，长时间离开</li><li>dnd：请勿打扰</li></ul></li><li>status：自由文本，即 rich presence 或 extended presence</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-XML data-lang=XML><span class=line><span class=cl><span class=nt>&lt;presence</span> <span class=na>from=</span><span class=s>&#39;nobody@caoyue.me/test&#39;</span> <span class=na>xml:lang=</span><span class=s>&#39;en&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;show&gt;</span>dnd<span class=nt>&lt;/show&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;status&gt;</span>Busy!<span class=nt>&lt;/status&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/presence&gt;</span>
</span></span></code></pre></div></li><li><p>IQ (Info/Query)<br>请求／响应消息，如获取用户的好友列表。</p><ul><li>type:<ul><li>get: 获取一个值</li><li>set: 设置或替换 get 查询的值</li><li>result: 服务器响应了先前的查询，返回结果如好友列表</li><li>error: 请求或响应出现错误</li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-XML data-lang=XML><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>from=</span><span class=s>&#39;nobody@caoyue.me/test&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>id=</span><span class=s>&#39;xxxxxx&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>to=</span><span class=s>&#39;test&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>type=</span><span class=s>&#39;subscribe&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ping</span> <span class=na>xmlns=</span><span class=s>&#39;urn:xmpp:ping&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;iq</span> <span class=na>from=</span><span class=s>&#39;test&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>id=</span><span class=s>&#39;xxxxxx&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>to=</span><span class=s>&#39;nobody@caoyue.me/test&#39;</span>
</span></span><span class=line><span class=cl>   <span class=na>type=</span><span class=s>&#39;error&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;error</span> <span class=na>type=</span><span class=s>&#39;modify&#39;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>       <span class=nt>&lt;bad-request</span> <span class=na>xmlns=</span><span class=s>&#39;urn:ietf:params:xml:ns:xmpp-stanzas&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/error&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/iq&gt;</span>
</span></span></code></pre></div></li></ul></li></ul><p>Ref:<br>[1] <a href=http://xmpp.org/rfcs/rfc6120.html>http://xmpp.org/rfcs/rfc6120.html</a><br>[2] <a href=http://en.wikipedia.org/wiki/XMPP>http://en.wikipedia.org/wiki/XMPP</a></p></div><div class=tags><ul class=info><li>2014-08-05</li><li><a href=https://blog.caoyue.me/tags/ejabberd>#ejabberd</a></li></ul></div></div><nav class=pager><a class=pre href=/posts/page/2/>Previous</a>
<a class=next href=/posts/page/4/>Next</a></nav></div><footer class=footer><div>©2023 <a href=/>且听疯吟</a>. designed
by <a href=https://caoyue.me target=_blank>caoyue</a>.
powered by <a href=https://gohugo.io/ target=_blank>hugo</a>.
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "1a24e73fd4284bfa8b43ecf5a5c2c100"}'></script>
<script defer src=https://use.typekit.net/jdb5cpn.js></script>
<script type=text/javascript>try{Typekit.load({async:!0})}catch{}</script></div></footer></div></body></html>